Index: workspace/src/main/kotlin/com/ampairs/workspace/security/WorkspaceAuthorizationService.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.ampairs.workspace.security\n\nimport com.ampairs.core.multitenancy.TenantContextHolder\nimport com.ampairs.core.security.AuthenticationHelper\nimport com.ampairs.core.service.UserService\nimport com.ampairs.workspace.model.enums.WorkspaceRole\nimport com.ampairs.workspace.service.WorkspaceMemberService\nimport org.springframework.security.core.Authentication\nimport org.springframework.stereotype.Service\n\n/**\n * Service for workspace-level authorization checks using Spring Security\n * This centralizes all workspace permission logic for use with @PreAuthorize\n */\n@Service(\"workspaceAuthorizationService\")\nclass WorkspaceAuthorizationService(\n    private val memberService: WorkspaceMemberService,\n    private val userService: UserService,\n) {\n\n    /**\n     * Check if the authenticated user has permission to perform an action on a workspace\n     * Used with @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, 'WORKSPACE_UPDATE')\")\n     */\n    fun hasWorkspacePermission(authentication: Authentication, workspaceId: String, permission: String): Boolean {\n        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false\n        return memberService.hasPermission(workspaceId, userId, permission)\n    }\n\n    /**\n     * Check if the authenticated user has permission to perform an action on a workspace (enum version)\n     * Used with @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).WORKSPACE_UPDATE)\")\n     */\n    fun hasWorkspacePermission(\n        authentication: Authentication,\n        workspaceId: String,\n        permission: WorkspacePermission\n    ): Boolean {\n        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false\n        return memberService.hasPermission(workspaceId, userId, permission.permissionName)\n    }\n\n    /**\n     * Check if user is workspace member (any role)\n     */\n    fun isWorkspaceMember(authentication: Authentication, workspaceId: String): Boolean {\n        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false\n        return memberService.isWorkspaceMember(workspaceId, userId)\n    }\n\n    /**\n     * Check if user has permission in the current tenant workspace\n     * Used when tenant context is already set by SessionUserFilter\n     */\n    fun hasCurrentTenantPermission(authentication: Authentication, permission: String): Boolean {\n        val workspaceId = TenantContextHolder.getCurrentTenant() ?: return false\n        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false\n        return memberService.hasPermission(workspaceId, userId, permission)\n    }\n\n    /**\n     * Check if user has permission in the current tenant workspace (enum version)\n     */\n    fun hasCurrentTenantPermission(authentication: Authentication, permission: WorkspacePermission): Boolean {\n        return hasCurrentTenantPermission(authentication, permission.permissionName)\n    }\n\n    /**\n     * Check if user is member of the current tenant workspace\n     */\n    fun isCurrentTenantMember(authentication: Authentication): Boolean {\n        val workspaceId = TenantContextHolder.getCurrentTenant() ?: return false\n        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false\n        return memberService.isWorkspaceMember(workspaceId, userId)\n    }\n\n    /**\n     * Check if user has specific role or higher in workspace\n     */\n    fun hasWorkspaceRole(authentication: Authentication, workspaceId: String, requiredRole: WorkspaceRole): Boolean {\n        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false\n        val userRole = memberService.getUserRole(workspaceId, userId) ?: return false\n        return userRole.hasPermissionLevel(requiredRole)\n    }\n\n    /**\n     * Check if user has specific role or higher in current tenant workspace\n     */\n    fun hasCurrentTenantRole(authentication: Authentication, requiredRole: WorkspaceRole): Boolean {\n        val workspaceId = TenantContextHolder.getCurrentTenant() ?: return false\n        return hasWorkspaceRole(authentication, workspaceId, requiredRole)\n    }\n\n    /**\n     * Check if user is workspace admin (ADMIN role or higher) in current tenant\n     */\n    fun isCurrentTenantAdmin(authentication: Authentication): Boolean {\n        return hasCurrentTenantRole(authentication, WorkspaceRole.ADMIN)\n    }\n\n    /**\n     * Check if user is workspace manager (MANAGER role or higher) in current tenant\n     */\n    fun isCurrentTenantManager(authentication: Authentication): Boolean {\n        return hasCurrentTenantRole(authentication, WorkspaceRole.MANAGER)\n    }\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/workspace/src/main/kotlin/com/ampairs/workspace/security/WorkspaceAuthorizationService.kt b/workspace/src/main/kotlin/com/ampairs/workspace/security/WorkspaceAuthorizationService.kt
--- a/workspace/src/main/kotlin/com/ampairs/workspace/security/WorkspaceAuthorizationService.kt	(revision 17c1f93ee95cfea6cba06c996df42a105b414d8a)
+++ b/workspace/src/main/kotlin/com/ampairs/workspace/security/WorkspaceAuthorizationService.kt	(date 1756782290175)
@@ -18,15 +18,6 @@
     private val userService: UserService,
 ) {
 
-    /**
-     * Check if the authenticated user has permission to perform an action on a workspace
-     * Used with @PreAuthorize("@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, 'WORKSPACE_UPDATE')")
-     */
-    fun hasWorkspacePermission(authentication: Authentication, workspaceId: String, permission: String): Boolean {
-        val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false
-        return memberService.hasPermission(workspaceId, userId, permission)
-    }
-
     /**
      * Check if the authenticated user has permission to perform an action on a workspace (enum version)
      * Used with @PreAuthorize("@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).WORKSPACE_UPDATE)")
@@ -37,7 +28,7 @@
         permission: WorkspacePermission
     ): Boolean {
         val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false
-        return memberService.hasPermission(workspaceId, userId, permission.permissionName)
+        return memberService.hasPermission(workspaceId, userId, permission)
     }
 
     /**
@@ -52,19 +43,12 @@
      * Check if user has permission in the current tenant workspace
      * Used when tenant context is already set by SessionUserFilter
      */
-    fun hasCurrentTenantPermission(authentication: Authentication, permission: String): Boolean {
+    fun hasCurrentTenantPermission(authentication: Authentication, permission: WorkspacePermission): Boolean {
         val workspaceId = TenantContextHolder.getCurrentTenant() ?: return false
         val userId = AuthenticationHelper.getCurrentUserId(authentication) ?: return false
         return memberService.hasPermission(workspaceId, userId, permission)
     }
 
-    /**
-     * Check if user has permission in the current tenant workspace (enum version)
-     */
-    fun hasCurrentTenantPermission(authentication: Authentication, permission: WorkspacePermission): Boolean {
-        return hasCurrentTenantPermission(authentication, permission.permissionName)
-    }
-
     /**
      * Check if user is member of the current tenant workspace
      */
Index: workspace/src/main/kotlin/com/ampairs/workspace/controller/WorkspaceMemberController.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.ampairs.workspace.controller\n\nimport com.ampairs.core.domain.dto.ApiResponse\nimport com.ampairs.core.domain.dto.PageResponse\nimport com.ampairs.core.security.AuthenticationHelper\nimport com.ampairs.workspace.model.dto.*\nimport com.ampairs.workspace.model.enums.WorkspaceRole\nimport com.ampairs.workspace.security.WorkspacePermission\nimport com.ampairs.workspace.service.WorkspaceMemberService\nimport io.swagger.v3.oas.annotations.Operation\nimport io.swagger.v3.oas.annotations.Parameter\nimport io.swagger.v3.oas.annotations.media.Content\nimport io.swagger.v3.oas.annotations.media.ExampleObject\nimport io.swagger.v3.oas.annotations.media.Schema\nimport io.swagger.v3.oas.annotations.responses.ApiResponses\nimport io.swagger.v3.oas.annotations.security.SecurityRequirement\nimport io.swagger.v3.oas.annotations.tags.Tag\nimport jakarta.validation.Valid\nimport org.springframework.data.domain.PageRequest\nimport org.springframework.data.domain.Sort\nimport org.springframework.http.HttpHeaders\nimport org.springframework.http.ResponseEntity\nimport org.springframework.security.access.prepost.PreAuthorize\nimport org.springframework.security.core.Authentication\nimport org.springframework.security.core.context.SecurityContextHolder\nimport org.springframework.web.bind.annotation.*\nimport io.swagger.v3.oas.annotations.responses.ApiResponse as SwaggerApiResponse\n\n/**\n * **Workspace Member Management Controller**\n *\n * Comprehensive member management operations including role assignments,\n * permissions, and member lifecycle management within workspace contexts.\n */\n@Tag(\n    name = \"Workspace Member Management\",\n    description = \"\"\"\n    ## \uD83D\uDC65 **Multi-Tenant Member Management System**\n    \n    **Advanced member management for workspace collaboration and access control.**\n    \n    ### \uD83C\uDFAF **Core Capabilities**\n    - **Member Discovery**: View and search workspace members with detailed information\n    - **Role Management**: Assign and modify member roles (OWNER, ADMIN, MANAGER, MEMBER, VIEWER)\n    - **Permission Control**: Fine-grained permission management for workspace operations\n    - **Member Lifecycle**: Add, update, and remove members from workspaces\n    - **Access Monitoring**: Track member activity and access patterns\n    \n    ### \uD83D\uDD10 **Security & Access Control**\n    - **Role Hierarchy**: OWNER → ADMIN → MANAGER → MEMBER → GUEST → VIEWER\n    - **Permission-Based Operations**: Each endpoint requires specific workspace permissions\n    - **Tenant Isolation**: Complete data separation between different workspaces\n    - **Audit Trail**: Comprehensive logging of all member management actions\n    \n    ### \uD83D\uDCCB **Member Role Definitions**\n    \n    | Role      | Description                           | Key Permissions                      |\n    |-----------|---------------------------------------|-------------------------------------|\n    | **OWNER** | Workspace owner with full control    | All permissions, cannot be removed |\n    | **ADMIN** | Administrative access to workspace   | Manage members, settings, billing   |\n    | **MANAGER**| Business operations management       | Manage data, reports, limited admin |\n    | **MEMBER**| Standard workspace participant       | Create/edit data, basic operations  |\n    | **GUEST** | Limited temporary access             | View-only with restricted scope     |\n    | **VIEWER**| Read-only access to workspace        | View data, generate basic reports   |\n    \n    ### \uD83D\uDD11 **Required Headers**\n    - **Authorization**: `Bearer {jwt_token}` - Valid JWT authentication token\n    - **X-Workspace-ID**: `{workspace_id}` - Target workspace identifier for multi-tenant operations\n    \n    ### \uD83D\uDCCA **API Usage Patterns**\n    1. **List Members**: View all workspace members with roles and permissions\n    2. **Member Details**: Get comprehensive information about specific members\n    3. **Role Updates**: Modify member roles and permission assignments\n    4. **Member Removal**: Remove members from workspace access\n    5. **Permission Check**: Verify current user's permissions and capabilities\n    \"\"\"\n)\n@RestController\n@RequestMapping(\"/workspace/v1\")\n@SecurityRequirement(name = \"BearerAuth\")\n@SecurityRequirement(name = \"WorkspaceContext\")\nclass WorkspaceMemberController(\n    private val memberService: WorkspaceMemberService,\n) {\n\n    @Operation(\n        summary = \"Get Workspace Members\",\n        description = \"\"\"\n        ## \uD83D\uDC65 **Retrieve Paginated Workspace Member List**\n        \n        Fetches a comprehensive list of all workspace members with their roles,\n        permissions, activity status, and contact information.\n        \n        ### **Response Information:**\n        - **Member Profiles**: Name, email, avatar, and contact details\n        - **Role Information**: Current role assignments and effective permissions\n        - **Activity Status**: Last seen, login frequency, and engagement metrics\n        - **Join Information**: Join date, invitation details, and onboarding status\n        - **Access Control**: Current permissions and restrictions for each member\n        \n        ### **Sorting Options:**\n        - **`joinedAt`** (default): Order by member join date\n        - **`name`**: Alphabetical ordering by member name\n        - **`role`**: Group by role hierarchy (Owner → Admin → Manager → Member → Viewer)\n        - **`lastActivity`**: Order by most recent activity or login\n        - **`email`**: Alphabetical ordering by email address\n        \n        ### **Use Cases:**\n        - **Member Directory**: Display comprehensive member directory in admin panels\n        - **Access Review**: Audit member access and permissions for compliance\n        - **Activity Monitoring**: Track member engagement and workspace participation\n        - **Team Management**: Support HR and team coordination activities\n        \n        ### **Business Benefits:**\n        - Provides complete visibility into workspace membership and access\n        - Enables effective team management and collaboration coordination\n        - Supports compliance and security auditing requirements\n        \"\"\",\n        tags = [\"Member Management\"]\n    )\n    @ApiResponses(\n        value = [\n            SwaggerApiResponse(\n                responseCode = \"200\",\n                description = \"✅ Successfully retrieved workspace members\",\n                content = [Content(\n                    mediaType = \"application/json\",\n                    schema = Schema(implementation = ApiResponse::class),\n                    examples = [ExampleObject(\n                        name = \"Workspace Members Response\",\n                        value = \"\"\"{{\n  \"success\": true,\n  \"data\": {{\n    \"content\": [\n      {{\n        \"id\": \"MBR_001_JOHN_DOE\",\n        \"user_id\": \"USR_JOHN_DOE_123\",\n        \"email\": \"john.doe@example.com\",\n        \"name\": \"John Doe\",\n        \"role\": \"ADMIN\",\n        \"status\": \"ACTIVE\",\n        \"joined_at\": \"2025-01-10T09:15:00Z\",\n        \"last_activity\": \"2025-01-15T14:30:00Z\",\n        \"permissions\": [\n          \"WORKSPACE_MANAGE\",\n          \"MEMBER_INVITE\",\n          \"MEMBER_MANAGE\"\n        ],\n        \"avatar_url\": \"https://example.com/avatars/john-doe.jpg\",\n        \"phone\": \"+1-555-0123\",\n        \"department\": \"Engineering\",\n        \"is_online\": true\n      }},\n      {{\n        \"id\": \"MBR_002_JANE_SMITH\",\n        \"user_id\": \"USR_JANE_SMITH_456\",\n        \"email\": \"jane.smith@example.com\",\n        \"name\": \"Jane Smith\",\n        \"role\": \"MANAGER\",\n        \"status\": \"ACTIVE\",\n        \"joined_at\": \"2025-01-12T11:20:00Z\",\n        \"last_activity\": \"2025-01-15T13:45:00Z\",\n        \"permissions\": [\n          \"MEMBER_VIEW\",\n          \"DATA_MANAGE\"\n        ],\n        \"avatar_url\": null,\n        \"phone\": \"+1-555-0456\",\n        \"department\": \"Sales\",\n        \"is_online\": false\n      }}\n    ],\n    \"page\": 0,\n    \"size\": 20,\n    \"total_elements\": 15,\n    \"total_pages\": 1,\n    \"is_first\": true,\n    \"is_last\": true\n  }},\n  \"timestamp\": \"2025-01-15T10:30:00Z\"\n}}\"\"\"\n                    )]\n                )]\n            ),\n            SwaggerApiResponse(\n                responseCode = \"401\",\n                description = \"\uD83D\uDEAB Authentication required - Invalid or missing JWT token\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"403\",\n                description = \"⛔ Access denied - Missing MEMBER_VIEW permission or workspace access\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"404\",\n                description = \"\uD83D\uDD0D Workspace not found - Invalid workspace ID\"\n            )\n        ]\n    )\n    @GetMapping(\"/{workspaceId}/members\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun getWorkspaceMembers(\n        @Parameter(\n            name = \"workspaceId\",\n            description = \"\"\"\n            **Target Workspace Identifier**\n            \n            The unique identifier of the workspace whose members you want to retrieve.\n            \n            **Format:** Usually follows pattern 'WS_XXXXX_YYYYY'\n            **Example:** 'WS_ABC123_XYZ789'\n            \n            **How to get Workspace ID:**\n            1. Call `GET /workspace/v1` to list user's workspaces\n            2. Use the `id` field from workspace list\n            3. Or use workspace selection from user interface\n            \"\"\",\n            required = true,\n            example = \"WS_ABC123_XYZ789\"\n        )\n        @PathVariable workspaceId: String,\n\n        @Parameter(\n            name = \"page\",\n            description = \"**Page number** (0-based) for pagination. Default: 0\",\n            example = \"0\"\n        )\n        @RequestParam(defaultValue = \"0\") page: Int,\n\n        @Parameter(\n            name = \"size\",\n            description = \"**Page size** - number of members per page (1-100). Default: 20\",\n            example = \"20\"\n        )\n        @RequestParam(defaultValue = \"20\") size: Int,\n\n        @Parameter(\n            name = \"sortBy\",\n            description = \"\"\"\n            **Sort field** for ordering results. Available options:\n            - `joinedAt` (default) - Order by join date\n            - `name` - Alphabetical by member name\n            - `email` - Alphabetical by email address\n            - `role` - Group by role hierarchy\n            - `lastActivity` - Order by recent activity\n            \"\"\",\n            example = \"joinedAt\"\n        )\n        @RequestParam(defaultValue = \"joinedAt\") sortBy: String,\n\n        @Parameter(\n            name = \"sortDir\",\n            description = \"**Sort direction**: `asc` (ascending) or `desc` (descending). Default: desc\",\n            example = \"desc\"\n        )\n        @RequestParam(defaultValue = \"desc\") sortDir: String,\n    ): ApiResponse<PageResponse<MemberListResponse>> {\n        val sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy)\n        val pageable = PageRequest.of(page, size, sort)\n\n        val members = memberService.getWorkspaceMembersOptimized(workspaceId, pageable)\n        return ApiResponse.success(PageResponse.from(members))\n    }\n\n    @Operation(\n        summary = \"Get Member Details\",\n        description = \"\"\"\n        ## \uD83D\uDC64 **Retrieve Comprehensive Member Information**\n        \n        Fetches detailed information about a specific workspace member including\n        profile data, role assignments, permissions, activity history, and preferences.\n        \n        ### **Detailed Information Provided:**\n        - **Profile Data**: Full name, email, phone, avatar, and bio information\n        - **Role & Permissions**: Current role, effective permissions, and access restrictions\n        - **Activity Timeline**: Recent actions, login history, and engagement patterns\n        - **Workspace Context**: Join date, invitation details, and workspace-specific settings\n        - **Contact Information**: Communication preferences and availability status\n        \n        ### **Use Cases:**\n        - **Member Profile Pages**: Display comprehensive member profiles in UI\n        - **Permission Verification**: Check specific member's access rights and capabilities\n        - **Activity Monitoring**: Review individual member engagement and contributions\n        - **Contact Management**: Access member contact details for communication\n        - **Security Auditing**: Review member access patterns and permissions for compliance\n        \n        ### **Business Benefits:**\n        - Enables personalized member management and communication\n        - Provides detailed insights for performance reviews and team coordination\n        - Supports security auditing and compliance requirements\n        \"\"\",\n        tags = [\"Member Details\"]\n    )\n    @ApiResponses(\n        value = [\n            SwaggerApiResponse(\n                responseCode = \"200\",\n                description = \"✅ Successfully retrieved member details\",\n                content = [Content(\n                    mediaType = \"application/json\",\n                    schema = Schema(implementation = ApiResponse::class),\n                    examples = [ExampleObject(\n                        name = \"Member Details Response\",\n                        value = \"\"\"{{\n  \"success\": true,\n  \"data\": {{\n    \"id\": \"MBR_001_JOHN_DOE\",\n    \"user_id\": \"USR_JOHN_DOE_123\",\n    \"workspace_id\": \"WS_ABC123_XYZ789\",\n    \"email\": \"john.doe@example.com\",\n    \"name\": \"John Doe\",\n    \"role\": \"ADMIN\",\n    \"status\": \"ACTIVE\",\n    \"joined_at\": \"2025-01-10T09:15:00Z\",\n    \"last_activity\": \"2025-01-15T14:30:00Z\",\n    \"profile\": {{\n      \"avatar_url\": \"https://example.com/avatars/john-doe.jpg\",\n      \"phone\": \"+1-555-0123\",\n      \"department\": \"Engineering\",\n      \"job_title\": \"Senior Software Engineer\",\n      \"bio\": \"Full-stack developer with 8+ years experience\",\n      \"timezone\": \"America/New_York\",\n      \"is_online\": true,\n      \"last_seen\": \"2025-01-15T14:30:00Z\"\n    }},\n    \"permissions\": [\n      \"WORKSPACE_MANAGE\",\n      \"MEMBER_INVITE\",\n      \"MEMBER_MANAGE\",\n      \"MEMBER_VIEW\",\n      \"DATA_MANAGE\",\n      \"REPORTS_VIEW\"\n    ],\n    \"activity_summary\": {{\n      \"total_logins\": 47,\n      \"days_active\": 28,\n      \"last_action\": \"Updated customer record\",\n      \"favorite_modules\": [\"Customer CRM\", \"Sales Pipeline\"]\n    }},\n    \"workspace_context\": {{\n      \"invited_by\": \"jane.admin@example.com\",\n      \"invitation_accepted_at\": \"2025-01-10T09:45:00Z\",\n      \"role_changed_at\": \"2025-01-12T15:20:00Z\",\n      \"settings\": {{\n        \"notifications_enabled\": true,\n        \"email_updates\": \"weekly\",\n        \"dashboard_layout\": \"advanced\"\n      }}\n    }}\n  }},\n  \"timestamp\": \"2025-01-15T10:30:00Z\"\n}}\"\"\"\n                    )]\n                )]\n            ),\n            SwaggerApiResponse(\n                responseCode = \"401\",\n                description = \"\uD83D\uDEAB Authentication required - Invalid or missing JWT token\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"403\",\n                description = \"⛔ Access denied - Missing MEMBER_VIEW permission\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"404\",\n                description = \"\uD83D\uDD0D Member not found - Invalid member ID or not in workspace\"\n            )\n        ]\n    )\n    @GetMapping(\"/{workspaceId}/members/{memberId}\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun getMemberDetails(\n        @Parameter(\n            name = \"workspaceId\",\n            description = \"**Target workspace identifier** where the member belongs\",\n            required = true,\n            example = \"WS_ABC123_XYZ789\"\n        )\n        @PathVariable workspaceId: String,\n\n        @Parameter(\n            name = \"memberId\",\n            description = \"\"\"\n            **Unique Member Identifier**\n            \n            The specific identifier for the workspace member whose details you want to retrieve.\n            \n            **Format:** Usually follows pattern 'MBR_###_NAME'\n            **Example:** 'MBR_001_JOHN_DOE'\n            \n            **How to find Member ID:**\n            1. Call `GET /workspace/v1/{workspaceId}/members` to list all members\n            2. Use the `id` field from the member list response\n            3. Member IDs are consistent across all API calls\n            \"\"\",\n            required = true,\n            example = \"MBR_001_JOHN_DOE\"\n        )\n        @PathVariable memberId: String,\n    ): ApiResponse<MemberResponse> {\n        val member = memberService.getMemberById(memberId)\n        return ApiResponse.success(member)\n    }\n\n    @Operation(\n        summary = \"Update Member Role & Permissions\",\n        description = \"\"\"\n        ## ⚙\uFE0F **Modify Member Role and Permission Assignments**\n        \n        Updates a workspace member's role, permissions, and access settings.\n        This operation allows workspace administrators to modify member privileges\n        and access control based on business requirements and security policies.\n        \n        ### **Updatable Properties:**\n        \n        #### **\uD83D\uDD11 Role Changes**\n        - **Role Promotion**: Elevate member to higher responsibility roles\n        - **Role Demotion**: Reduce member access for security or organizational changes\n        - **Role Restrictions**: Apply temporary or permanent access limitations\n        \n        #### **\uD83D\uDD10 Permission Updates**\n        - **Custom Permissions**: Grant or revoke specific operational permissions\n        - **Module Access**: Control access to specific business modules and features\n        - **Data Scope**: Limit data access to specific categories or departments\n        \n        #### **\uD83D\uDCCB Profile Updates**\n        - **Contact Information**: Update member communication preferences\n        - **Department Assignment**: Change organizational department or team\n        - **Notification Settings**: Modify alert and communication preferences\n        \n        ### **Role Change Rules:**\n        \n        | Current Role | Can Update To | Restrictions |\n        |--------------|---------------|-------------|\n        | **OWNER** | None | Cannot be changed (only transferred) |\n        | **ADMIN** | MANAGER, MEMBER, VIEWER | Requires OWNER permission |\n        | **MANAGER** | MEMBER, VIEWER | Can be updated by ADMIN+ |\n        | **MEMBER** | VIEWER, GUEST | Can be updated by MANAGER+ |\n        | **VIEWER** | GUEST | Can be updated by MANAGER+ |\n        \n        ### **Security Considerations:**\n        - **Permission Elevation**: Role promotions require higher-level authorization\n        - **Audit Trail**: All role changes are logged with timestamps and reasons\n        - **Immediate Effect**: Permission changes take effect immediately across all sessions\n        - **Notification**: Affected members receive automatic notifications of access changes\n        \n        ### **Use Cases:**\n        - **Organizational Changes**: Reflect promotions, demotions, or department transfers\n        - **Access Control**: Implement security policies and compliance requirements\n        - **Temporary Access**: Grant temporary elevated permissions for specific projects\n        - **Onboarding**: Gradually increase new member permissions as they gain experience\n        \"\"\",\n        tags = [\"Member Management\"]\n    )\n    @ApiResponses(\n        value = [\n            SwaggerApiResponse(\n                responseCode = \"200\",\n                description = \"✅ Member successfully updated\",\n                content = [Content(\n                    mediaType = \"application/json\",\n                    schema = Schema(implementation = ApiResponse::class),\n                    examples = [ExampleObject(\n                        name = \"Updated Member Response\",\n                        value = \"\"\"{{\n  \"success\": true,\n  \"data\": {{\n    \"id\": \"MBR_001_JOHN_DOE\",\n    \"user_id\": \"USR_JOHN_DOE_123\",\n    \"workspace_id\": \"WS_ABC123_XYZ789\",\n    \"email\": \"john.doe@example.com\",\n    \"name\": \"John Doe\",\n    \"role\": \"MANAGER\",\n    \"status\": \"ACTIVE\",\n    \"updated_at\": \"2025-01-15T10:30:00Z\",\n    \"updated_by\": \"admin@example.com\",\n    \"permissions\": [\n      \"MEMBER_VIEW\",\n      \"DATA_MANAGE\",\n      \"REPORTS_VIEW\"\n    ],\n    \"change_summary\": {{\n      \"previous_role\": \"ADMIN\",\n      \"new_role\": \"MANAGER\",\n      \"permissions_removed\": [\"WORKSPACE_MANAGE\", \"MEMBER_MANAGE\"],\n      \"permissions_added\": [],\n      \"reason\": \"Organizational restructuring\"\n    }}\n  }},\n  \"timestamp\": \"2025-01-15T10:30:00Z\"\n}}\"\"\"\n                    )]\n                )]\n            ),\n            SwaggerApiResponse(\n                responseCode = \"400\",\n                description = \"❌ Bad request - Invalid role or permission data\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"401\",\n                description = \"\uD83D\uDEAB Authentication required - Invalid or missing JWT token\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"403\",\n                description = \"⛔ Access denied - Missing MEMBER_MANAGE permission or insufficient role level\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"404\",\n                description = \"\uD83D\uDD0D Member not found - Invalid member ID\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"409\",\n                description = \"⚠\uFE0F Conflict - Cannot update OWNER role or role hierarchy violation\"\n            )\n        ]\n    )\n    @PutMapping(\"/{workspaceId}/members/{memberId}\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_MANAGE)\")\n    fun updateMember(\n        @Parameter(\n            name = \"workspaceId\",\n            description = \"**Target workspace identifier** containing the member to update\",\n            required = true,\n            example = \"WS_ABC123_XYZ789\"\n        )\n        @PathVariable workspaceId: String,\n\n        @Parameter(\n            name = \"memberId\",\n            description = \"\"\"\n            **Member ID to Update**\n            \n            The unique identifier of the workspace member whose role and permissions you want to modify.\n            \n            **Important Notes:**\n            - Cannot update OWNER role (only transfer ownership)\n            - Role changes are subject to hierarchy restrictions\n            - Member will receive notification of role changes\n            \"\"\",\n            required = true,\n            example = \"MBR_001_JOHN_DOE\"\n        )\n        @PathVariable memberId: String,\n\n        @io.swagger.v3.oas.annotations.parameters.RequestBody(\n            description = \"\"\"\n            **Member Update Information**\n            \n            Specify the new role and permissions for the workspace member.\n            \n            **Example Request Body:**\n            ```json\n            {\n              \"role\": \"MANAGER\",\n              \"custom_permissions\": [\"DATA_MANAGE\", \"REPORTS_VIEW\"],\n              \"department\": \"Sales\",\n              \"reason\": \"Promotion to team lead position\",\n              \"notify_member\": true\n            }\n            ```\n            \n            **Available Roles:** ADMIN, MANAGER, MEMBER, VIEWER, GUEST\n            **Available Permissions:** WORKSPACE_MANAGE, MEMBER_INVITE, MEMBER_MANAGE, MEMBER_VIEW, DATA_MANAGE, REPORTS_VIEW\n            \"\"\",\n            required = true\n        )\n        @RequestBody @Valid request: UpdateMemberRequest,\n    ): ApiResponse<MemberResponse> {\n        val auth: Authentication = SecurityContextHolder.getContext().authentication\n        val userId = AuthenticationHelper.getCurrentUserId(auth)\n            ?: throw IllegalStateException(\"User not authenticated\")\n\n        val updatedMember = memberService.updateMember(workspaceId, memberId, request, userId)\n        return ApiResponse.success(updatedMember)\n    }\n\n    @Operation(\n        summary = \"Remove Member from Workspace\",\n        description = \"\"\"\n        ## \uD83D\uDDD1\uFE0F **Remove Member Access from Workspace**\n        \n        Permanently removes a member from the workspace, revoking all access rights\n        and permissions. This operation is irreversible and requires high-level authorization.\n        \n        ### **Removal Process:**\n        \n        #### **\uD83D\uDEAA Access Revocation**\n        - **Immediate Effect**: All access tokens and sessions are invalidated instantly\n        - **Permission Removal**: All workspace permissions are permanently revoked\n        - **Data Access**: Member loses access to all workspace data and resources\n        - **Module Access**: Removed from all business modules and integrations\n        \n        #### **\uD83D\uDCCB Data Handling**\n        - **Ownership Transfer**: Member's data ownership is transferred to workspace admin\n        - **Audit Trail**: Complete removal history is maintained for compliance\n        - **Backup Creation**: Optional data backup before member removal\n        - **Reference Cleanup**: Member references in shared documents are handled gracefully\n        \n        #### **\uD83D\uDCE7 Notification Process**\n        - **Member Notification**: Removed member receives notification (if enabled)\n        - **Admin Notification**: Workspace admins are notified of member removal\n        - **Audit Log**: Detailed removal record is created for security audit\n        \n        ### **Removal Restrictions:**\n        \n        | Member Role | Can Be Removed By | Special Considerations |\n        |-------------|------------------|------------------------|\n        | **OWNER** | Cannot be removed | Only ownership transfer available |\n        | **ADMIN** | OWNER only | Requires OWNER-level authorization |\n        | **MANAGER** | OWNER, ADMIN | Requires ADMIN+ authorization |\n        | **MEMBER** | OWNER, ADMIN, MANAGER | Standard removal process |\n        | **VIEWER** | OWNER, ADMIN, MANAGER | Standard removal process |\n        \n        ### **Security Considerations:**\n        - **Access Validation**: Verify remover has sufficient permissions\n        - **Session Termination**: All active sessions are immediately terminated\n        - **Token Revocation**: JWT tokens are blacklisted across all devices\n        - **Data Security**: Sensitive data access is immediately revoked\n        \n        ### **Use Cases:**\n        - **Employee Offboarding**: Remove departing employees from workspace access\n        - **Security Incident**: Immediately revoke access for compromised accounts\n        - **Access Control**: Remove members who no longer require workspace access\n        - **Compliance**: Meet regulatory requirements for access management\n        \n        ### **Recovery Options:**\n        - **Re-invitation**: Removed members can be re-invited with new permissions\n        - **Data Recovery**: Admin can access transferred data if needed\n        - **Audit Review**: Complete removal history available for investigation\n        \"\"\",\n        tags = [\"Member Management\"]\n    )\n    @ApiResponses(\n        value = [\n            SwaggerApiResponse(\n                responseCode = \"200\",\n                description = \"✅ Member successfully removed from workspace\",\n                content = [Content(\n                    mediaType = \"application/json\",\n                    schema = Schema(implementation = ApiResponse::class),\n                    examples = [ExampleObject(\n                        name = \"Member Removal Success\",\n                        value = \"\"\"{{\n  \"success\": true,\n  \"data\": {{\n    \"message\": \"Member MBR_001_JOHN_DOE successfully removed from workspace WS_ABC123_XYZ789\",\n    \"removal_details\": {{\n      \"member_id\": \"MBR_001_JOHN_DOE\",\n      \"member_name\": \"John Doe\",\n      \"member_email\": \"john.doe@example.com\",\n      \"workspace_id\": \"WS_ABC123_XYZ789\",\n      \"removed_at\": \"2025-01-15T10:30:00Z\",\n      \"removed_by\": \"admin@example.com\",\n      \"previous_role\": \"MANAGER\"\n    }},\n    \"impact_summary\": {{\n      \"sessions_terminated\": 2,\n      \"tokens_revoked\": 3,\n      \"data_ownership_transferred\": true,\n      \"notification_sent\": true\n    }},\n    \"recovery_options\": {{\n      \"can_reinvite\": true,\n      \"data_retention_days\": 30,\n      \"audit_trail_available\": true\n    }}\n  }},\n  \"timestamp\": \"2025-01-15T10:30:00Z\"\n}}\"\"\"\n                    )]\n                )]\n            ),\n            SwaggerApiResponse(\n                responseCode = \"401\",\n                description = \"\uD83D\uDEAB Authentication required - Invalid or missing JWT token\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"403\",\n                description = \"⛔ Access denied - Missing MEMBER_DELETE permission or insufficient role level\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"404\",\n                description = \"\uD83D\uDD0D Member not found - Invalid member ID or already removed\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"409\",\n                description = \"⚠\uFE0F Conflict - Cannot remove OWNER or violation of business rules\"\n            )\n        ]\n    )\n    @DeleteMapping(\"/{workspaceId}/members/{memberId}\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_DELETE)\")\n    fun removeMember(\n        @Parameter(\n            name = \"workspaceId\",\n            description = \"**Target workspace identifier** from which to remove the member\",\n            required = true,\n            example = \"WS_ABC123_XYZ789\"\n        )\n        @PathVariable workspaceId: String,\n\n        @Parameter(\n            name = \"memberId\",\n            description = \"\"\"\n            **Member ID to Remove**\n            \n            The unique identifier of the workspace member to remove permanently.\n            \n            **Critical Notes:**\n            - **OWNER cannot be removed** - only ownership transfer is possible\n            - **Removal is permanent** - member will lose all workspace access\n            - **Sessions terminated** - all active sessions will be ended immediately\n            - **Data transferred** - member's data ownership transferred to admin\n            \n            **Before Removal:**\n            1. Ensure data backup if needed\n            2. Transfer any critical ownership or responsibilities\n            3. Notify stakeholders of the member removal\n            4. Consider temporary role demotion instead of removal\n            \"\"\",\n            required = true,\n            example = \"MBR_001_JOHN_DOE\"\n        )\n        @PathVariable memberId: String,\n    ): ApiResponse<String> {\n        val auth: Authentication = SecurityContextHolder.getContext().authentication\n        val userId = AuthenticationHelper.getCurrentUserId(auth)\n            ?: throw IllegalStateException(\"User not authenticated\")\n\n        val result = memberService.removeMember(workspaceId, memberId, userId)\n        return ApiResponse.success(result)\n    }\n\n    @Operation(\n        summary = \"Get Current User's Role & Permissions\",\n        description = \"\"\"\n        ## \uD83D\uDD11 **Retrieve Current User's Workspace Access Information**\n        \n        Returns comprehensive information about the authenticated user's role,\n        permissions, and access rights within the specified workspace context.\n        \n        ### **Information Provided:**\n        \n        #### **\uD83D\uDCDC Role Information**\n        - **Current Role**: User's assigned role in the workspace (OWNER, ADMIN, MANAGER, etc.)\n        - **Role Hierarchy**: Position in organizational hierarchy\n        - **Role Description**: Detailed explanation of role responsibilities\n        - **Role Limitations**: Any specific restrictions or temporary limitations\n        \n        #### **\uD83D\uDD10 Permission Matrix**\n        - **Workspace Management**: Can modify workspace settings and configuration\n        - **Member Management**: Can invite, update, or remove workspace members\n        - **Data Operations**: Can create, read, update, delete business data\n        - **Module Access**: Available business modules and their access levels\n        - **Report Generation**: Can access and generate various business reports\n        - **Integration Management**: Can manage external integrations and APIs\n        \n        #### **\uD83D\uDCCB Context Information**\n        - **Membership Status**: Active, pending, or restricted status\n        - **Join Information**: When and how user joined the workspace\n        - **Last Activity**: Recent actions and engagement within workspace\n        - **Session Details**: Current session information and device context\n        \n        ### **Permission Categories:**\n        \n        | Permission Category | Description | Typical Roles |\n        |--------------------|-------------|---------------|\n        | **WORKSPACE_MANAGE** | Full workspace administration | OWNER, ADMIN |\n        | **MEMBER_INVITE** | Invite new members to workspace | ADMIN, MANAGER |\n        | **MEMBER_MANAGE** | Modify member roles and permissions | OWNER, ADMIN |\n        | **MEMBER_VIEW** | View member directory and details | MANAGER+ |\n        | **DATA_MANAGE** | Create/update business data | MEMBER+ |\n        | **REPORTS_VIEW** | Access reports and analytics | MEMBER+ |\n        \n        ### **Use Cases:**\n        - **UI Permission Control**: Show/hide UI elements based on user permissions\n        - **Feature Availability**: Determine which features are accessible\n        - **Navigation Menu**: Customize menu items based on access rights\n        - **Security Validation**: Client-side permission validation for better UX\n        - **Role-Based Routing**: Direct users to appropriate sections based on role\n        \n        ### **Integration Benefits:**\n        - **Dynamic UI**: Build responsive interfaces that adapt to user permissions\n        - **Security Layer**: Add client-side security checks for better user experience\n        - **Personalization**: Customize workspace experience based on user role\n        - **Compliance**: Support audit and compliance requirements with detailed access logs\n        \"\"\",\n        tags = [\"Permission Management\"]\n    )\n    @ApiResponses(\n        value = [\n            SwaggerApiResponse(\n                responseCode = \"200\",\n                description = \"✅ Successfully retrieved user role and permissions\",\n                content = [Content(\n                    mediaType = \"application/json\",\n                    schema = Schema(implementation = ApiResponse::class),\n                    examples = [ExampleObject(\n                        name = \"User Role & Permissions Response\",\n                        value = \"\"\"{{\n  \"success\": true,\n  \"data\": {{\n    \"user_id\": \"USR_JOHN_DOE_123\",\n    \"workspace_id\": \"WS_ABC123_XYZ789\",\n    \"current_role\": \"MANAGER\",\n    \"membership_status\": \"ACTIVE\",\n    \"joined_at\": \"2025-01-10T09:15:00Z\",\n    \"last_activity\": \"2025-01-15T14:30:00Z\",\n    \"role_hierarchy\": {{\n      \"is_owner\": false,\n      \"is_admin\": false,\n      \"is_manager\": true,\n      \"is_member\": true,\n      \"is_viewer\": true\n    }},\n    \"permissions\": {{\n      \"workspace_management\": {{\n        \"can_manage_workspace\": false,\n        \"can_view_settings\": true,\n        \"can_modify_settings\": false,\n        \"can_delete_workspace\": false\n      }},\n      \"member_management\": {{\n        \"can_view_members\": true,\n        \"can_invite_members\": true,\n        \"can_manage_members\": false,\n        \"can_remove_members\": false\n      }},\n      \"data_operations\": {{\n        \"can_view_data\": true,\n        \"can_create_data\": true,\n        \"can_update_data\": true,\n        \"can_delete_data\": true,\n        \"can_export_data\": true\n      }},\n      \"reporting\": {{\n        \"can_view_reports\": true,\n        \"can_create_reports\": true,\n        \"can_share_reports\": false,\n        \"can_access_analytics\": true\n      }}\n    }},\n    \"module_access\": [\n      \"customer_management\",\n      \"product_catalog\", \n      \"sales_pipeline\",\n      \"basic_reporting\"\n    ],\n    \"restrictions\": {{\n      \"temporary_limitations\": [],\n      \"access_hours\": null,\n      \"ip_restrictions\": [],\n      \"module_restrictions\": []\n    }}\n  }},\n  \"timestamp\": \"2025-01-15T10:30:00Z\"\n}}\"\"\"\n                    )]\n                )]\n            ),\n            SwaggerApiResponse(\n                responseCode = \"401\",\n                description = \"\uD83D\uDEAB Authentication required - Invalid or missing JWT token\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"403\",\n                description = \"⛔ Access denied - Not a workspace member\"\n            ),\n            SwaggerApiResponse(\n                responseCode = \"404\",\n                description = \"\uD83D\uDD0D Workspace not found - Invalid workspace ID\"\n            )\n        ]\n    )\n    @GetMapping(\"/{workspaceId}/my-role\")\n    @PreAuthorize(\"@workspaceAuthorizationService.isWorkspaceMember(authentication, #workspaceId)\")\n    fun getMyRole(\n        @Parameter(\n            name = \"workspaceId\",\n            description = \"\"\"\n            **Target Workspace Identifier**\n            \n            The unique identifier of the workspace for which you want to check\n            your current role and permissions.\n            \n            **Context:** This endpoint provides context-specific permission information.\n            Your role and permissions may vary across different workspaces.\n            \n            **Usage:** Use this endpoint to:\n            1. **Customize UI**: Show/hide features based on permissions\n            2. **Validate Access**: Check if user can perform specific operations\n            3. **Dynamic Navigation**: Build role-appropriate menu systems\n            4. **Security Checks**: Implement client-side permission validation\n            \"\"\",\n            required = true,\n            example = \"WS_ABC123_XYZ789\"\n        )\n        @PathVariable workspaceId: String,\n    ): ApiResponse<com.ampairs.workspace.model.dto.UserRoleResponse> {\n        val auth: Authentication = SecurityContextHolder.getContext().authentication\n        val userId = AuthenticationHelper.getCurrentUserId(auth)\n            ?: throw IllegalStateException(\"User not authenticated\")\n\n        // Get member details\n        val member = memberService.getWorkspaceMember(workspaceId, userId)\n            ?: throw IllegalStateException(\"User is not a member of workspace\")\n\n        // Build role hierarchy\n        val roleHierarchy = mapOf(\n            \"OWNER\" to memberService.isWorkspaceOwner(workspaceId, userId),\n            \"ADMIN\" to (member.role.name in listOf(\"OWNER\", \"ADMIN\")),\n            \"MANAGER\" to (member.role.name in listOf(\"OWNER\", \"ADMIN\", \"MANAGER\")),\n            \"MEMBER\" to (member.role.name in listOf(\"OWNER\", \"ADMIN\", \"MANAGER\", \"MEMBER\")),\n            \"VIEWER\" to true\n        )\n\n        // Build detailed permissions\n        val permissions = mapOf(\n            \"workspace\" to mapOf(\n                \"manage\" to memberService.hasPermission(\n                    workspaceId,\n                    userId,\n                    WorkspacePermission.WORKSPACE_MANAGE.permissionName\n                ),\n                \"view\" to true,\n                \"delete\" to memberService.hasPermission(\n                    workspaceId,\n                    userId,\n                    WorkspacePermission.WORKSPACE_DELETE.permissionName\n                )\n            ),\n            \"members\" to mapOf(\n                \"view\" to memberService.hasPermission(\n                    workspaceId,\n                    userId,\n                    WorkspacePermission.MEMBER_VIEW.permissionName\n                ),\n                \"invite\" to memberService.hasPermission(\n                    workspaceId,\n                    userId,\n                    WorkspacePermission.MEMBER_INVITE.permissionName\n                ),\n                \"manage\" to memberService.hasPermission(\n                    workspaceId,\n                    userId,\n                    WorkspacePermission.MEMBER_MANAGE.permissionName\n                ),\n                \"remove\" to memberService.hasPermission(\n                    workspaceId,\n                    userId,\n                    WorkspacePermission.MEMBER_DELETE.permissionName\n                )\n            )\n        )\n\n        // Module access based on role\n        val moduleAccess = when (member.role) {\n            com.ampairs.workspace.model.enums.WorkspaceRole.OWNER,\n            com.ampairs.workspace.model.enums.WorkspaceRole.ADMIN -> listOf(\"all\")\n\n            com.ampairs.workspace.model.enums.WorkspaceRole.MANAGER -> listOf(\n                \"customer\",\n                \"product\",\n                \"order\",\n                \"invoice\",\n                \"reports\"\n            )\n\n            com.ampairs.workspace.model.enums.WorkspaceRole.MEMBER -> listOf(\"customer\", \"product\", \"order\")\n            else -> listOf(\"customer\")\n        }\n\n        val result = com.ampairs.workspace.model.dto.UserRoleResponse(\n            userId = userId,\n            workspaceId = workspaceId,\n            currentRole = member.role.name,\n            membershipStatus = if (member.isActive) \"ACTIVE\" else \"INACTIVE\",\n            joinedAt = (member.joinedAt ?: member.createdAt ?: java.time.LocalDateTime.now()).toString(),\n            lastActivity = member.lastActiveAt?.toString(),\n            roleHierarchy = roleHierarchy,\n            permissions = permissions,\n            moduleAccess = moduleAccess\n        )\n\n        return ApiResponse.success(result)\n    }\n\n    @Operation(\n        summary = \"Search Workspace Members\",\n        description = \"\"\"\n        ## \uD83D\uDD0D **Advanced Member Search with Filtering**\n        \n        Search and filter workspace members with comprehensive filtering options including\n        role, status, department, and text-based search across member profiles.\n        \n        ### **Search Capabilities:**\n        - **Text Search**: Search across name, email, and profile information\n        - **Role Filtering**: Filter by specific workspace roles\n        - **Status Filtering**: Filter by member status (ACTIVE, INACTIVE, etc.)\n        - **Department Filtering**: Filter by organizational department\n        - **Combined Filters**: Use multiple filters simultaneously for precise results\n        \n        ### **Sorting Options:**\n        - **Name**: Alphabetical sorting by member name\n        - **Email**: Alphabetical sorting by email address\n        - **Role**: Sort by role hierarchy\n        - **Join Date**: Sort by when member joined workspace\n        - **Last Activity**: Sort by most recent activity\n        \n        ### **Use Cases:**\n        - **Quick Search**: Find specific members by name or email\n        - **Role Management**: View all members with specific roles\n        - **Department Views**: Filter members by organizational structure\n        - **Status Monitoring**: View active, inactive, or pending members\n        \"\"\",\n        tags = [\"Member Search\"]\n    )\n    @GetMapping(\"/{workspaceId}/members/search\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun searchWorkspaceMembers(\n        @PathVariable workspaceId: String,\n        @RequestParam(defaultValue = \"0\") page: Int,\n        @RequestParam(defaultValue = \"20\") size: Int,\n        @RequestParam(defaultValue = \"joinedAt\") sortBy: String,\n        @RequestParam(defaultValue = \"desc\") sortDir: String,\n        @RequestParam(required = false) role: String?,\n        @RequestParam(required = false) status: String?,\n        @RequestParam(required = false) department: String?,\n        @RequestParam(required = false) search_query: String?\n    ): ApiResponse<PageResponse<MemberListResponse>> {\n        val sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy)\n        val pageable = PageRequest.of(page, size, sort)\n\n        // Use the same service method with additional filtering\n        val members = memberService.searchWorkspaceMembers(\n            workspaceId,\n            search_query,\n            role,\n            status,\n            department,\n            pageable\n        )\n        return ApiResponse.success(PageResponse.from(members))\n    }\n\n    @Operation(\n        summary = \"Get Member Statistics\",\n        description = \"\"\"\n        ## \uD83D\uDCCA **Workspace Member Analytics and Statistics**\n        \n        Retrieve comprehensive statistics about workspace membership including\n        member counts, role distribution, activity metrics, and trend analysis.\n        \n        ### **Statistical Data:**\n        - **Member Counts**: Total, active, inactive member counts\n        - **Role Distribution**: Breakdown of members by role hierarchy\n        - **Status Analysis**: Member status distribution and health metrics\n        - **Activity Trends**: Recent joining patterns and engagement metrics\n        - **Department Analytics**: Member distribution across departments\n        \n        ### **Business Insights:**\n        - **Growth Tracking**: Monitor workspace membership growth over time\n        - **Role Balance**: Ensure proper distribution of roles and responsibilities\n        - **Engagement Analysis**: Track member activity and participation\n        - **Compliance Metrics**: Support audit and compliance reporting needs\n        \"\"\",\n        tags = [\"Member Analytics\"]\n    )\n    @GetMapping(\"/{workspaceId}/members/statistics\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun getMemberStatistics(\n        @PathVariable workspaceId: String\n    ): ApiResponse<Map<String, Any>> {\n        val statistics = memberService.getMemberStatistics(workspaceId)\n        return ApiResponse.success(statistics)\n    }\n\n    @Operation(\n        summary = \"Get Workspace Departments\",\n        description = \"\"\"\n        ## \uD83C\uDFE2 **Retrieve Available Departments**\n        \n        Get list of all departments that have members in the workspace.\n        Useful for filtering and organizational structure display.\n        \n        ### **Department Information:**\n        - **Active Departments**: Only departments with current members\n        - **Alphabetical Sorting**: Departments returned in alphabetical order\n        - **Member Count**: Optional member count per department\n        \n        ### **Use Cases:**\n        - **Filter Options**: Populate department filter dropdowns\n        - **Organizational View**: Display workspace organizational structure\n        - **Admin Tools**: Support HR and management reporting\n        \"\"\",\n        tags = [\"Department Management\"]\n    )\n    @GetMapping(\"/{workspaceId}/members/departments\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun getWorkspaceDepartments(\n        @PathVariable workspaceId: String\n    ): ApiResponse<List<String>> {\n        val departments = memberService.getWorkspaceDepartments(workspaceId)\n        return ApiResponse.success(departments)\n    }\n\n    @Operation(\n        summary = \"Bulk Update Members\",\n        description = \"\"\"\n        ## \uD83D\uDD04 **Bulk Member Operations**\n        \n        Update multiple workspace members simultaneously with role changes,\n        status updates, or department assignments.\n        \n        ### **Bulk Operations:**\n        - **Role Updates**: Change multiple member roles at once\n        - **Status Changes**: Activate, deactivate, or suspend multiple members\n        - **Department Moves**: Transfer members between departments\n        - **Permission Updates**: Apply permission changes across multiple members\n        \n        ### **Safety Features:**\n        - **Transaction Safety**: All updates succeed or all fail\n        - **Validation**: Pre-validation of all changes before execution\n        - **Audit Trail**: Complete logging of all bulk operations\n        - **Notification**: Optional member notification of changes\n        \"\"\",\n        tags = [\"Bulk Operations\"]\n    )\n    @PutMapping(\"/{workspaceId}/members/bulk\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_MANAGE)\")\n    fun bulkUpdateMembers(\n        @PathVariable workspaceId: String,\n        @RequestBody request: Map<String, Any>\n    ): ApiResponse<Map<String, Any>> {\n        val result = memberService.bulkUpdateMembers(workspaceId, request)\n        return ApiResponse.success(result)\n    }\n\n    @Operation(\n        summary = \"Bulk Remove Members\",\n        description = \"\"\"\n        ## \uD83D\uDDD1\uFE0F **Bulk Member Removal**\n        \n        Remove multiple members from workspace simultaneously with proper\n        cleanup and notification handling.\n        \n        ### **Bulk Removal Process:**\n        - **Multi-Member Selection**: Remove multiple members in single operation\n        - **Data Cleanup**: Proper handling of member data and permissions\n        - **Audit Logging**: Complete record of removal operations\n        - **Notification**: Optional notification to removed members\n        \"\"\",\n        tags = [\"Bulk Operations\"]\n    )\n    @DeleteMapping(\"/{workspaceId}/members/bulk\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_DELETE)\")\n    fun bulkRemoveMembers(\n        @PathVariable workspaceId: String,\n        @RequestBody request: Map<String, Any>\n    ): ApiResponse<Map<String, Any>> {\n        val result = memberService.bulkRemoveMembers(workspaceId, request)\n        return ApiResponse.success(result)\n    }\n\n    @Operation(\n        summary = \"Export Members Data\",\n        description = \"\"\"\n        ## \uD83D\uDCE4 **Export Member Data**\n        \n        Export workspace member data in various formats (CSV, Excel) with\n        optional filtering and custom field selection.\n        \n        ### **Export Formats:**\n        - **CSV**: Comma-separated values for spreadsheet applications\n        - **Excel**: Microsoft Excel format with formatting\n        - **Filtered Export**: Apply same filters as member search\n        \n        ### **Export Data:**\n        - **Basic Info**: Name, email, role, status, join date\n        - **Extended Info**: Department, last activity, permissions\n        - **Custom Fields**: Select specific fields for export\n        \"\"\",\n        tags = [\"Data Export\"]\n    )\n    @GetMapping(\"/{workspaceId}/members/export\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun exportMembers(\n        @PathVariable workspaceId: String,\n        @RequestParam(defaultValue = \"CSV\") format: String,\n        @RequestParam(required = false) role: String?,\n        @RequestParam(required = false) status: String?,\n        @RequestParam(required = false) department: String?,\n        @RequestParam(required = false) search_query: String?\n    ): ResponseEntity<ByteArray> {\n        val exportData = memberService.exportMembers(workspaceId, format, role, status, department, search_query)\n\n        val contentType = when (format.uppercase()) {\n            \"EXCEL\" -> \"application/vnd.ms-excel\"\n            else -> \"text/csv\"\n        }\n\n        val filename = \"workspace-members-${java.time.LocalDate.now()}.${format.lowercase()}\"\n\n        return ResponseEntity.ok()\n            .header(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"$filename\\\"\")\n            .header(HttpHeaders.CONTENT_TYPE, contentType)\n            .body(exportData)\n    }\n\n    @Operation(\n        summary = \"Update Member Status\",\n        description = \"\"\"\n        ## \uD83D\uDD04 **Update Member Status**\n        \n        Update a specific member's status (ACTIVE, INACTIVE, SUSPENDED, etc.)\n        with optional reason and notification.\n        \n        ### **Status Options:**\n        - **ACTIVE**: Full workspace access and permissions\n        - **INACTIVE**: Temporary suspension of access\n        - **SUSPENDED**: Administrative suspension with audit trail\n        - **PENDING**: Awaiting activation or approval\n        \n        ### **Status Change Process:**\n        - **Immediate Effect**: Status changes take effect immediately\n        - **Session Management**: Suspended members are logged out\n        - **Audit Trail**: Complete logging of status changes\n        - **Notifications**: Optional member and admin notifications\n        \"\"\",\n        tags = [\"Member Status\"]\n    )\n    @PatchMapping(\"/{workspaceId}/members/{memberId}/status\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_MANAGE)\")\n    fun updateMemberStatus(\n        @PathVariable workspaceId: String,\n        @PathVariable memberId: String,\n        @RequestBody request: Map<String, Any>\n    ): ApiResponse<MemberResponse> {\n        val status = request[\"status\"] as? String ?: throw IllegalArgumentException(\"Status is required\")\n        val reason = request[\"reason\"] as? String\n\n        val updatedMember = memberService.updateMemberStatus(workspaceId, memberId, status, reason)\n        return ApiResponse.success(updatedMember)\n    }\n\n    @Operation(\n        summary = \"Get Workspace Roles\",\n        description = \"\"\"\n        ## \uD83C\uDFAD **Get Available Workspace Roles**\n        \n        Retrieve all available roles that can be assigned to workspace members.\n        This endpoint provides role hierarchy, permissions, and descriptions.\n        \n        ### **Role Information:**\n        - **Role Details**: Name, display name, level, and description\n        - **Permission Hierarchy**: Understanding role inheritance and capabilities\n        - **Assignment Rules**: Which roles can assign/manage other roles\n        - **Level System**: Numeric hierarchy for permission comparison\n        \n        ### **Role Hierarchy (High to Low):**\n        - **OWNER (100)**: Full workspace control including deletion\n        - **ADMIN (80)**: Administrative access with member management\n        - **MANAGER (60)**: Project and team management capabilities\n        - **MEMBER (40)**: Standard workspace collaboration access\n        - **GUEST (20)**: Limited access for external collaborators\n        - **VIEWER (10)**: Read-only access to workspace content\n        \"\"\",\n        tags = [\"Workspace Configuration\"]\n    )\n    @GetMapping(\"/{workspaceId}/roles\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun getWorkspaceRoles(\n        @PathVariable workspaceId: String\n    ): ApiResponse<List<WorkspaceRoleResponse>> {\n        val roles = WorkspaceRole.entries.map { role ->\n            WorkspaceRoleResponse(\n                name = role.name,\n                displayName = role.displayName,\n                level = role.level,\n                description = role.description,\n                manageableRoles = role.getManageableRoles().map { it.name }\n            )\n        }\n        return ApiResponse.success(roles)\n    }\n\n    @Operation(\n        summary = \"Get Workspace Permissions\",\n        description = \"\"\"\n        ## \uD83D\uDD10 **Get Available Workspace Permissions**\n        \n        Retrieve all available permissions that can be assigned to workspace members.\n        This endpoint provides comprehensive permission details for role management.\n        \n        ### **Permission Categories:**\n        \n        #### **Workspace Management**\n        - **WORKSPACE_MANAGE**: Manage workspace settings, details, and configuration\n        - **WORKSPACE_DELETE**: Delete or archive the entire workspace\n        \n        #### **Member Management**\n        - **MEMBER_VIEW**: View workspace members and their basic information\n        - **MEMBER_INVITE**: Send invitations to new workspace members\n        - **MEMBER_MANAGE**: Manage member roles, permissions, and settings\n        - **MEMBER_DELETE**: Remove members from the workspace\n        \n        ### **Permission Usage:**\n        - **Role Assignment**: Default permissions per role level\n        - **Custom Permissions**: Fine-grained access control overrides\n        - **Security Model**: Type-safe permission checking and validation\n        - **Audit Trail**: Complete logging of permission changes\n        \"\"\",\n        tags = [\"Workspace Configuration\"]\n    )\n    @GetMapping(\"/{workspaceId}/permissions\")\n    @PreAuthorize(\"@workspaceAuthorizationService.hasWorkspacePermission(authentication, #workspaceId, T(com.ampairs.workspace.security.WorkspacePermission).MEMBER_VIEW)\")\n    fun getWorkspacePermissions(\n        @PathVariable workspaceId: String\n    ): ApiResponse<List<WorkspacePermissionResponse>> {\n        val permissions = WorkspacePermission.entries.map { permission ->\n            WorkspacePermissionResponse(\n                name = permission.name,\n                permissionName = permission.permissionName,\n                description = when (permission) {\n                    WorkspacePermission.WORKSPACE_MANAGE -> \"Manage workspace settings, details, and configuration\"\n                    WorkspacePermission.WORKSPACE_DELETE -> \"Delete or archive the entire workspace\"\n                    WorkspacePermission.MEMBER_VIEW -> \"View workspace members and their basic information\"\n                    WorkspacePermission.MEMBER_INVITE -> \"Send invitations to new workspace members\"\n                    WorkspacePermission.MEMBER_MANAGE -> \"Manage member roles, permissions, and settings\"\n                    WorkspacePermission.MEMBER_DELETE -> \"Remove members from the workspace\"\n                }\n            )\n        }\n        return ApiResponse.success(permissions)\n    }\n\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/workspace/src/main/kotlin/com/ampairs/workspace/controller/WorkspaceMemberController.kt b/workspace/src/main/kotlin/com/ampairs/workspace/controller/WorkspaceMemberController.kt
--- a/workspace/src/main/kotlin/com/ampairs/workspace/controller/WorkspaceMemberController.kt	(revision 17c1f93ee95cfea6cba06c996df42a105b414d8a)
+++ b/workspace/src/main/kotlin/com/ampairs/workspace/controller/WorkspaceMemberController.kt	(date 1756782431534)
@@ -895,7 +895,7 @@
             example = "WS_ABC123_XYZ789"
         )
         @PathVariable workspaceId: String,
-    ): ApiResponse<com.ampairs.workspace.model.dto.UserRoleResponse> {
+    ): ApiResponse<UserRoleResponse> {
         val auth: Authentication = SecurityContextHolder.getContext().authentication
         val userId = AuthenticationHelper.getCurrentUserId(auth)
             ?: throw IllegalStateException("User not authenticated")
@@ -919,45 +919,45 @@
                 "manage" to memberService.hasPermission(
                     workspaceId,
                     userId,
-                    WorkspacePermission.WORKSPACE_MANAGE.permissionName
+                    WorkspacePermission.WORKSPACE_MANAGE
                 ),
                 "view" to true,
                 "delete" to memberService.hasPermission(
                     workspaceId,
                     userId,
-                    WorkspacePermission.WORKSPACE_DELETE.permissionName
+                    WorkspacePermission.WORKSPACE_DELETE
                 )
             ),
             "members" to mapOf(
                 "view" to memberService.hasPermission(
                     workspaceId,
                     userId,
-                    WorkspacePermission.MEMBER_VIEW.permissionName
+                    WorkspacePermission.MEMBER_VIEW
                 ),
                 "invite" to memberService.hasPermission(
                     workspaceId,
                     userId,
-                    WorkspacePermission.MEMBER_INVITE.permissionName
+                    WorkspacePermission.MEMBER_INVITE
                 ),
                 "manage" to memberService.hasPermission(
                     workspaceId,
                     userId,
-                    WorkspacePermission.MEMBER_MANAGE.permissionName
+                    WorkspacePermission.MEMBER_MANAGE
                 ),
                 "remove" to memberService.hasPermission(
                     workspaceId,
                     userId,
-                    WorkspacePermission.MEMBER_DELETE.permissionName
+                    WorkspacePermission.MEMBER_DELETE
                 )
             )
         )
 
         // Module access based on role
         val moduleAccess = when (member.role) {
-            com.ampairs.workspace.model.enums.WorkspaceRole.OWNER,
-            com.ampairs.workspace.model.enums.WorkspaceRole.ADMIN -> listOf("all")
+            WorkspaceRole.OWNER,
+            WorkspaceRole.ADMIN -> listOf("all")
 
-            com.ampairs.workspace.model.enums.WorkspaceRole.MANAGER -> listOf(
+            WorkspaceRole.MANAGER -> listOf(
                 "customer",
                 "product",
                 "order",
@@ -965,11 +965,11 @@
                 "reports"
             )
 
-            com.ampairs.workspace.model.enums.WorkspaceRole.MEMBER -> listOf("customer", "product", "order")
+            WorkspaceRole.MEMBER -> listOf("customer", "product", "order")
             else -> listOf("customer")
         }
 
-        val result = com.ampairs.workspace.model.dto.UserRoleResponse(
+        val result = UserRoleResponse(
             userId = userId,
             workspaceId = workspaceId,
             currentRole = member.role.name,
Index: workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceService.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.ampairs.workspace.service\n\nimport com.ampairs.core.exception.BusinessException\nimport com.ampairs.core.exception.NotFoundException\nimport com.ampairs.workspace.model.Workspace\nimport com.ampairs.workspace.model.dto.*\nimport com.ampairs.workspace.model.enums.SubscriptionPlan\nimport com.ampairs.workspace.model.enums.WorkspaceStatus\nimport com.ampairs.workspace.model.enums.WorkspaceType\nimport com.ampairs.workspace.repository.WorkspaceMemberRepository\nimport com.ampairs.workspace.repository.WorkspaceRepository\nimport com.ampairs.workspace.security.WorkspacePermission\nimport org.slf4j.LoggerFactory\nimport org.springframework.data.domain.Page\nimport org.springframework.data.domain.Pageable\nimport org.springframework.stereotype.Service\nimport org.springframework.transaction.annotation.Transactional\nimport java.time.LocalDateTime\nimport java.util.*\n\n/**\n * Service for workspace management operations\n */\n@Service\n@Transactional\nclass WorkspaceService(\n    private val workspaceRepository: WorkspaceRepository,\n    private val workspaceMemberRepository: WorkspaceMemberRepository,\n    private val memberService: WorkspaceMemberService,\n    private val invitationService: WorkspaceInvitationService,\n    private val settingsService: WorkspaceSettingsService,\n    private val activityService: WorkspaceActivityService,\n) {\n\n    companion object {\n        private val logger = LoggerFactory.getLogger(WorkspaceService::class.java)\n        private const val DEFAULT_SLUG_LENGTH = 8\n        private const val MAX_SLUG_ATTEMPTS = 10\n    }\n\n    /**\n     * Create a new workspace\n     */\n    fun createWorkspace(request: CreateWorkspaceRequest, createdBy: String): WorkspaceResponse {\n        logger.info(\"Creating workspace: ${request.name} for user: $createdBy\")\n\n        // Generate or validate slug\n        val slug = generateUniqueSlug(request.slug ?: generateSlugFromName(request.name))\n\n        // Create workspace entity\n        val workspace = Workspace().apply {\n            this.name = request.name\n            this.slug = slug\n            this.description = request.description\n            this.workspaceType = request.workspaceType\n            this.avatarUrl = request.avatarUrl\n            this.timezone = request.timezone\n            this.language = request.language\n            this.createdBy = createdBy\n            this.status = WorkspaceStatus.ACTIVE\n            this.subscriptionPlan = SubscriptionPlan.FREE\n            this.active = true\n            this.lastActivityAt = LocalDateTime.now()\n        }\n\n        val savedWorkspace = workspaceRepository.save(workspace)\n\n        // Add creator as owner\n        memberService.addMemberAsOwner(savedWorkspace.uid, createdBy)\n\n        // Initialize workspace settings\n        settingsService.initializeDefaultSettings(savedWorkspace.uid)\n\n        // Log activity\n        activityService.logWorkspaceCreated(savedWorkspace.uid, createdBy, \"Unknown User\")\n\n        logger.info(\"Successfully created workspace: ${savedWorkspace.uid}\")\n        return savedWorkspace.toResponse(memberCount = 1)\n    }\n\n    /**\n     * Get workspace by ID\n     */\n    fun getWorkspaceById(workspaceId: String, userId: String): WorkspaceResponse {\n        val workspace = findWorkspaceById(workspaceId)\n\n        // Check if user has access to this workspace\n        if (!memberService.isWorkspaceMember(workspace.uid, userId)) {\n            throw BusinessException(\"ACCESS_DENIED\", \"You don't have access to this workspace\")\n        }\n\n        val memberCount = memberService.getActiveMemberCount(workspace.uid)\n        return workspace.toResponse(memberCount = memberCount)\n    }\n\n    /**\n     * Get workspace by slug\n     */\n    fun getWorkspaceBySlug(slug: String, userId: String): WorkspaceResponse {\n        val workspace = workspaceRepository.findBySlug(slug)\n            .orElseThrow { NotFoundException(\"Workspace not found with slug: $slug\") }\n\n        // Check if user has access to this workspace\n        if (!memberService.isWorkspaceMember(workspace.uid, userId)) {\n            throw BusinessException(\"ACCESS_DENIED\", \"You don't have access to this workspace\")\n        }\n\n        val memberCount = memberService.getActiveMemberCount(workspace.uid)\n        return workspace.toResponse(memberCount = memberCount)\n    }\n\n    /**\n     * Update workspace information\n     */\n    fun updateWorkspace(workspaceId: String, request: UpdateWorkspaceRequest, updatedBy: String): WorkspaceResponse {\n        val workspace = findWorkspaceById(workspaceId)\n\n        // Check permissions\n        if (!memberService.hasPermission(workspaceId, updatedBy, WorkspacePermission.WORKSPACE_MANAGE.permissionName)) {\n            throw BusinessException(\"INSUFFICIENT_PERMISSIONS\", \"You don't have permission to update this workspace\")\n        }\n\n        // Update fields\n        request.name?.let { workspace.name = it }\n        request.description?.let { workspace.description = it }\n        request.workspaceType?.let { workspace.workspaceType = it }\n        request.avatarUrl?.let { workspace.avatarUrl = it }\n        request.timezone?.let { workspace.timezone = it }\n        request.language?.let { workspace.language = it }\n\n        workspace.lastActivityAt = LocalDateTime.now()\n\n        val updatedWorkspace = workspaceRepository.save(workspace)\n\n        // Log activity\n        activityService.logWorkspaceUpdated(workspaceId, updatedBy, \"Unknown User\")\n\n        // Get member count with fallback handling for database mapping issues\n        val memberCount = try {\n            memberService.getActiveMemberCount(workspace.uid)\n        } catch (e: Exception) {\n            logger.warn(\"Failed to get member count for workspace ${workspace.uid}: ${e.message}\")\n            // Fallback: use simple repository count or default value\n            try {\n                workspaceMemberRepository.countByWorkspaceIdAndIsActiveTrue(workspace.uid).toInt()\n            } catch (ex: Exception) {\n                logger.warn(\"Fallback member count also failed for workspace ${workspace.uid}: ${ex.message}\")\n                1 // Default fallback value\n            }\n        }\n\n        return updatedWorkspace.toResponse(memberCount = memberCount)\n    }\n\n    /**\n     * Get workspaces for a user\n     */\n    fun getUserWorkspaces(userId: String, pageable: Pageable): Page<WorkspaceListResponse> {\n        val workspaces = workspaceRepository.findWorkspacesByUserId(userId, pageable)\n\n        return workspaces.map { workspace ->\n            val memberCount = memberService.getActiveMemberCount(workspace.uid)\n            workspace.toListResponse(memberCount)\n        }\n    }\n\n    /**\n     * Search workspaces\n     */\n    fun searchWorkspaces(\n        query: String,\n        workspaceType: WorkspaceType?,\n        subscriptionPlan: SubscriptionPlan?,\n        userId: String,\n        pageable: Pageable,\n    ): Page<WorkspaceListResponse> {\n        val workspaces = workspaceRepository.searchWorkspaces(query, pageable)\n\n        return workspaces.map { workspace ->\n            val memberCount = memberService.getActiveMemberCount(workspace.uid)\n            workspace.toListResponse(memberCount)\n        }\n    }\n\n    /**\n     * Archive workspace (soft delete)\n     */\n    fun archiveWorkspace(workspaceId: String, archivedBy: String): String {\n        val workspace = findWorkspaceById(workspaceId)\n\n        // Check permissions - only owners can archive\n        if (!memberService.isWorkspaceOwner(workspaceId, archivedBy)) {\n            throw BusinessException(\"INSUFFICIENT_PERMISSIONS\", \"Only workspace owners can archive workspaces\")\n        }\n\n        workspace.status = WorkspaceStatus.ARCHIVED\n        workspace.active = false\n        workspaceRepository.save(workspace)\n\n        // Cancel all pending invitations\n        invitationService.cancelAllPendingInvitations(workspaceId, archivedBy, \"Workspace archived\")\n\n        // Log activity\n        activityService.logWorkspaceArchived(workspaceId, archivedBy, \"Unknown User\")\n\n        logger.info(\"Workspace archived: $workspaceId by user: $archivedBy\")\n        return \"Workspace archived successfully\"\n    }\n\n    /**\n     * Delete workspace permanently\n     */\n    fun deleteWorkspace(workspaceId: String, deletedBy: String): String {\n        val workspace = findWorkspaceById(workspaceId)\n\n        // Check permissions - only owners can delete\n        if (!memberService.isWorkspaceOwner(workspaceId, deletedBy)) {\n            throw BusinessException(\"INSUFFICIENT_PERMISSIONS\", \"Only workspace owners can delete workspaces\")\n        }\n\n        // Check if workspace has active subscription\n        if (workspace.subscriptionPlan != SubscriptionPlan.FREE) {\n            throw BusinessException(\"ACTIVE_SUBSCRIPTION\", \"Cannot delete workspace with active subscription\")\n        }\n\n        // Delete all related data\n        memberService.removeAllMembers(workspaceId)\n        invitationService.deleteAllInvitations(workspaceId)\n        settingsService.deleteSettings(workspaceId)\n        activityService.deleteActivities(workspaceId)\n\n        // Delete workspace\n        workspaceRepository.delete(workspace)\n\n        logger.info(\"Workspace permanently deleted: $workspaceId by user: $deletedBy\")\n        return \"Workspace deleted permanently\"\n    }\n\n    /**\n     * Check workspace availability (for slug)\n     */\n    fun checkSlugAvailability(slug: String): Map<String, Boolean> {\n        val isAvailable = !workspaceRepository.existsBySlug(slug)\n        return mapOf(\"available\" to isAvailable)\n    }\n\n    /**\n     * Get workspace member count\n     */\n    fun getWorkspaceMemberCount(workspaceId: String): Int {\n        return memberService.getActiveMemberCount(workspaceId)\n    }\n\n    /**\n     * Update workspace activity timestamp\n     */\n    fun updateLastActivity(workspaceId: String) {\n        workspaceRepository.updateLastActivity(workspaceId, LocalDateTime.now())\n    }\n\n    // Private helper methods\n\n    private fun findWorkspaceById(workspaceId: String): Workspace {\n        return workspaceRepository.findByUid(workspaceId)\n            .orElseThrow { NotFoundException(\"Workspace not found: $workspaceId\") }\n    }\n\n    private fun generateSlugFromName(name: String): String {\n        return name.lowercase()\n            .replace(Regex(\"[^a-z0-9\\\\s]\"), \"\")\n            .replace(Regex(\"\\\\s+\"), \"-\")\n            .take(30)\n    }\n\n    private fun generateUniqueSlug(preferredSlug: String): String {\n        var slug = preferredSlug\n        var attempt = 0\n\n        while (workspaceRepository.existsBySlug(slug) && attempt < MAX_SLUG_ATTEMPTS) {\n            attempt++\n            slug = \"$preferredSlug-${UUID.randomUUID().toString().substring(0, DEFAULT_SLUG_LENGTH)}\"\n        }\n\n        if (workspaceRepository.existsBySlug(slug)) {\n            throw BusinessException(\"SLUG_GENERATION_FAILED\", \"Unable to generate unique slug\")\n        }\n\n        return slug\n    }\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceService.kt b/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceService.kt
--- a/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceService.kt	(revision 17c1f93ee95cfea6cba06c996df42a105b414d8a)
+++ b/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceService.kt	(date 1756782442598)
@@ -116,7 +116,7 @@
         val workspace = findWorkspaceById(workspaceId)
 
         // Check permissions
-        if (!memberService.hasPermission(workspaceId, updatedBy, WorkspacePermission.WORKSPACE_MANAGE.permissionName)) {
+        if (!memberService.hasPermission(workspaceId, updatedBy, WorkspacePermission.WORKSPACE_MANAGE)) {
             throw BusinessException("INSUFFICIENT_PERMISSIONS", "You don't have permission to update this workspace")
         }
 
Index: workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceMemberService.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.ampairs.workspace.service\n\nimport com.ampairs.core.domain.User\nimport com.ampairs.core.exception.BusinessException\nimport com.ampairs.core.exception.NotFoundException\nimport com.ampairs.workspace.model.WorkspaceMember\nimport com.ampairs.workspace.model.dto.*\nimport com.ampairs.workspace.model.enums.WorkspaceRole\nimport com.ampairs.workspace.repository.WorkspaceMemberRepository\nimport org.slf4j.LoggerFactory\nimport org.springframework.data.domain.Page\nimport org.springframework.data.domain.Pageable\nimport org.springframework.stereotype.Service\nimport org.springframework.transaction.annotation.Transactional\nimport java.time.LocalDateTime\n\n/**\n * Service for workspace member management operations\n */\n@Service\n@Transactional\nclass WorkspaceMemberService(\n    private val memberRepository: WorkspaceMemberRepository,\n    private val activityService: WorkspaceActivityService,\n    private val userDetailProvider: UserDetailProvider\n) {\n\n    companion object {\n        private val logger = LoggerFactory.getLogger(WorkspaceMemberService::class.java)\n    }\n\n    /**\n     * Add member as owner (used during workspace creation)\n     */\n    fun addMemberAsOwner(workspaceId: String, userId: String): WorkspaceMember {\n        // Check if member already exists\n        val existingMember = memberRepository.findByWorkspaceIdAndUserId(workspaceId, userId)\n        if (existingMember.isPresent) {\n            val member = existingMember.get()\n            logger.warn(\"Member already exists for workspace: $workspaceId, user: $userId. Updating to owner role.\")\n\n            // Update existing member to owner role if not already\n            if (member.role != WorkspaceRole.OWNER) {\n                member.role = WorkspaceRole.OWNER\n                member.isActive = true\n                member.joinedAt = member.joinedAt ?: LocalDateTime.now()\n                return memberRepository.save(member)\n            }\n\n            return member\n        }\n\n        val member = WorkspaceMember().apply {\n            this.workspaceId = workspaceId\n            this.userId = userId\n            this.role = WorkspaceRole.OWNER\n            this.isActive = true\n            this.joinedAt = LocalDateTime.now()\n        }\n\n        val savedMember = memberRepository.save(member)\n        logger.info(\"Added owner to workspace: $workspaceId, user: $userId\")\n\n        return savedMember\n    }\n\n    /**\n     * Add member to workspace\n     */\n    fun addMember(workspaceId: String, userId: String, role: WorkspaceRole = WorkspaceRole.MEMBER): WorkspaceMember {\n        // Check if user is already a member\n        if (memberRepository.existsByWorkspaceIdAndUserId(workspaceId, userId)) {\n            throw BusinessException(\"MEMBER_ALREADY_EXISTS\", \"User is already a member of this workspace\")\n        }\n\n        val member = WorkspaceMember().apply {\n            this.workspaceId = workspaceId\n            this.userId = userId\n            this.role = role\n            this.isActive = true\n            this.joinedAt = LocalDateTime.now()\n        }\n\n        val savedMember = memberRepository.save(member)\n\n        // Log activity\n        activityService.logMemberAdded(workspaceId, userId, \"Unknown User\", role.name, \"SYSTEM\", \"System\")\n\n        logger.info(\"Added member to workspace: $workspaceId, user: $userId, role: $role\")\n        return savedMember\n    }\n\n    /**\n     * Update member role and permissions\n     */\n    fun updateMember(\n        workspaceId: String,\n        memberId: String,\n        request: UpdateMemberRequest,\n        updatedBy: String,\n    ): MemberResponse {\n        val member = findMemberById(memberId)\n\n        // Validate workspace\n        if (member.workspaceId != workspaceId) {\n            throw BusinessException(\"MEMBER_NOT_IN_WORKSPACE\", \"Member does not belong to this workspace\")\n        }\n\n        // Update fields\n        request.role?.let {\n            val oldRole = member.role\n            member.role = it\n\n            // Log role change\n            if (oldRole != it) {\n                activityService.logMemberRoleChanged(\n                    workspaceId,\n                    member.userId,\n                    \"Unknown User\",\n                    oldRole.name,\n                    it.name,\n                    updatedBy,\n                    \"Unknown User\"\n                )\n            }\n        }\n\n        request.customPermissions?.let { permissions ->\n            member.permissions = permissions\n        }\n\n        request.isActive?.let {\n            val wasActive = member.isActive\n            member.isActive = it\n\n            // Log activation/deactivation\n            if (wasActive != it) {\n                if (it) {\n                    activityService.logMemberActivated(\n                        workspaceId,\n                        member.userId,\n                        \"Unknown User\",\n                        updatedBy,\n                        \"Unknown User\"\n                    )\n                } else {\n                    activityService.logMemberDeactivated(\n                        workspaceId,\n                        member.userId,\n                        \"Unknown User\",\n                        updatedBy,\n                        \"Unknown User\"\n                    )\n                }\n            }\n        }\n\n        val updatedMember = memberRepository.save(member)\n        // Populate user detail if available\n        val userDetail =\n            if (userDetailProvider.isUserServiceAvailable()) userDetailProvider.getUserDetail(updatedMember.userId) else null\n        return updatedMember.toResponse(userDetail)\n    }\n\n    /**\n     * Remove member from workspace\n     */\n    fun removeMember(workspaceId: String, memberId: String, removedBy: String): String {\n        val member = findMemberById(memberId)\n\n        // Validate workspace\n        if (member.workspaceId != workspaceId) {\n            throw BusinessException(\"MEMBER_NOT_IN_WORKSPACE\", \"Member does not belong to this workspace\")\n        }\n\n        // Cannot remove the last owner\n        if (member.role == WorkspaceRole.OWNER) {\n            val ownerCount = memberRepository.countByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, WorkspaceRole.OWNER)\n            if (ownerCount <= 1) {\n                throw BusinessException(\"CANNOT_REMOVE_LAST_OWNER\", \"Cannot remove the last owner from workspace\")\n            }\n        }\n\n        memberRepository.delete(member)\n\n        // Log activity\n        activityService.logMemberRemoved(workspaceId, member.userId, \"Unknown User\", removedBy, \"Unknown User\")\n\n        logger.info(\"Removed member from workspace: $workspaceId, user: ${member.userId}\")\n        return \"Member removed successfully\"\n    }\n\n    /**\n     * Get workspace members\n     */\n    fun getWorkspaceMembers(workspaceId: String, pageable: Pageable): Page<MemberListResponse> {\n        val members = memberRepository.findByWorkspaceIdAndIsActiveTrue(workspaceId, pageable)\n        // Batch-load user details when provider is available to populate nested user DTOs\n        if (userDetailProvider.isUserServiceAvailable()) {\n            val userIds = members.content.map { it.userId }\n            val userDetails = userDetailProvider.getUserDetails(userIds)\n            return members.map { member ->\n                val ud = userDetails[member.userId]\n                member.toListResponse(ud)\n            }\n        }\n\n        return members.map { it.toListResponse() }\n    }\n\n    /**\n     * Get workspace members with optimized loading using EntityGraph\n     * This method uses @EntityGraph to efficiently load member details with their primary teams\n     * and avoids N+1 queries for both user information and team relationships.\n     *\n     * Additionally, if a UserDetailProvider is available, it will batch-load user details\n     * from the external user service for enhanced user information.\n     */\n    fun getWorkspaceMembersOptimized(workspaceId: String, pageable: Pageable): Page<MemberListResponse> {\n        logger.debug(\"Fetching workspace members with optimized loading (EntityGraph) for workspace: $workspaceId\")\n\n        // Use EntityGraph to load members with primary team in a single query\n        val members = memberRepository.findByWorkspaceIdAndIsActiveTrueWithPrimaryTeam(workspaceId, pageable)\n\n        // Extract user IDs for batch loading\n        val userIds = members.content.map { it.userId }\n\n        // Batch load user details if provider is available\n        val userDetails: Map<String, User> = if (userDetailProvider.isUserServiceAvailable()) {\n            userDetailProvider.getUserDetails(userIds)\n        } else {\n            emptyMap()\n        }\n\n        return members.map { member ->\n            val userDetail = userDetails[member.userId]\n            // The toListResponse method will now use the EntityGraph-loaded primaryTeam automatically\n            member.toListResponse(userDetail)\n        }\n    }\n\n    /**\n     * Extract first name from full name\n     */\n    private fun extractFirstName(fullName: String?): String? {\n        return fullName?.split(\" \")?.firstOrNull()\n    }\n\n    /**\n     * Extract last name from full name\n     */\n    private fun extractLastName(fullName: String?): String? {\n        val nameParts = fullName?.split(\" \")\n        return if (nameParts != null && nameParts.size > 1) {\n            nameParts.drop(1).joinToString(\" \")\n        } else null\n    }\n\n    /**\n     * Get member by ID with user details and team information using EntityGraph\n     */\n    fun getMemberById(memberId: String): MemberResponse {\n        val member = memberRepository.findByIdWithPrimaryTeam(memberId)\n            .orElseThrow { NotFoundException(\"Member not found: $memberId\") }\n        \n        val userDetail = if (userDetailProvider.isUserServiceAvailable()) {\n            userDetailProvider.getUserDetail(member.userId)\n        } else null\n        \n        // The toResponse method will use the EntityGraph-loaded primaryTeam automatically\n        return member.toResponse(userDetail)\n    }\n\n    /**\n     * Check if user is workspace member\n     */\n    fun isWorkspaceMember(workspaceId: String, userId: String): Boolean {\n        return memberRepository.existsByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)\n    }\n\n    /**\n     * Check if user is workspace owner\n     */\n    fun isWorkspaceOwner(workspaceId: String, userId: String): Boolean {\n        return memberRepository.existsByWorkspaceIdAndUserIdAndRoleAndIsActiveTrue(\n            workspaceId, userId, WorkspaceRole.OWNER\n        )\n    }\n\n    /**\n     * Get user's role in workspace\n     */\n    fun getUserRole(workspaceId: String, userId: String): WorkspaceRole? {\n        val member = memberRepository.findByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)\n        return member.orElse(null)?.role\n    }\n\n    /**\n     * Get workspace member by workspace ID and user ID with team information using EntityGraph\n     */\n    fun getWorkspaceMember(workspaceId: String, userId: String): WorkspaceMember? {\n        return memberRepository.findByWorkspaceIdAndUserIdAndIsActiveTrueWithPrimaryTeam(workspaceId, userId)\n            .orElse(null)\n    }\n\n    /**\n     * Check if user has specific permission\n     */\n    fun hasPermission(workspaceId: String, userId: String, permission: String): Boolean {\n        return try {\n            val member = memberRepository.findByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)\n                .orElse(null) ?: return false\n\n            // Standardized permission mapping with clear, consistent naming\n            when (permission) {\n                // Workspace management permissions (consolidated)\n                \"WORKSPACE_MANAGE\", \"WORKSPACE_UPDATE\", \"WORKSPACE_SETTINGS\" ->\n                    member.role in listOf(WorkspaceRole.OWNER, WorkspaceRole.ADMIN)\n\n                \"WORKSPACE_DELETE\", \"WORKSPACE_ARCHIVE\" ->\n                    member.role in listOf(WorkspaceRole.OWNER, WorkspaceRole.ADMIN)\n\n                // Member management permissions\n                \"MEMBER_VIEW\" -> true // All active members can view other members\n                \"MEMBER_INVITE\" -> member.role in listOf(\n                    WorkspaceRole.OWNER,\n                    WorkspaceRole.ADMIN,\n                    WorkspaceRole.MANAGER\n                )\n\n                \"MEMBER_MANAGE\" -> member.role in listOf(\n                    WorkspaceRole.OWNER,\n                    WorkspaceRole.ADMIN,\n                    WorkspaceRole.MANAGER\n                )\n\n                \"MEMBER_DELETE\", \"MEMBER_REMOVE\" -> member.role in listOf(\n                    WorkspaceRole.OWNER,\n                    WorkspaceRole.ADMIN,\n                    WorkspaceRole.MANAGER\n                )\n\n                else -> false\n            }\n        } catch (e: Exception) {\n            logger.warn(\"Error checking permissions for user $userId in workspace $workspaceId: ${e.message}\")\n            // Fallback: try alternative query or return conservative result\n            try {\n                // Alternative approach using existence check\n                memberRepository.existsByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)\n                // If exists but couldn't get role, be conservative and deny advanced permissions\n                when (permission) {\n                    \"VIEW_MEMBERS\" -> true // Basic permission\n                    else -> false // Conservative approach for advanced permissions\n                }\n            } catch (ex: Exception) {\n                logger.warn(\"Fallback permission check also failed for user $userId in workspace $workspaceId: ${ex.message}\")\n                false // Conservative fallback\n            }\n        }\n    }\n\n    /**\n     * Get active member count\n     */\n    fun getActiveMemberCount(workspaceId: String): Int {\n        return try {\n            memberRepository.countByWorkspaceIdAndIsActiveTrue(workspaceId).toInt()\n        } catch (e: Exception) {\n            logger.warn(\"Error getting active member count for workspace $workspaceId: ${e.message}\")\n            // Return a reasonable default - at least 1 (assuming workspace has an owner)\n            1\n        }\n    }\n\n    /**\n     * Get member statistics\n     */\n    fun getMemberStatistics(workspaceId: String): Map<String, Any> {\n        val totalMembers = memberRepository.countByWorkspaceId(workspaceId)\n        val activeMembers = memberRepository.countByWorkspaceIdAndIsActiveTrue(workspaceId)\n        val membersByRoleList = memberRepository.getMemberCountsByRole(workspaceId)\n        val membersByRole = membersByRoleList.associate {\n            (it[\"role\"] as WorkspaceRole).name to (it[\"count\"] as Long)\n        }\n        val recentJoins = memberRepository.countByWorkspaceIdAndJoinedAtAfter(\n            workspaceId,\n            LocalDateTime.now().minusDays(7)\n        )\n\n        return mapOf(\n            \"total_members\" to totalMembers,\n            \"active_members\" to activeMembers,\n            \"recent_joins\" to recentJoins,\n            \"by_role\" to membersByRole,\n            \"by_status\" to mapOf(\n                \"ACTIVE\" to activeMembers,\n                \"INACTIVE\" to (totalMembers - activeMembers),\n                \"PENDING\" to 0L, // Will be populated by invitation service\n                \"SUSPENDED\" to 0L\n            )\n        )\n    }\n\n    /**\n     * Search members\n     */\n    fun searchMembers(\n        workspaceId: String,\n        query: String,\n        role: WorkspaceRole?,\n        pageable: Pageable,\n    ): Page<MemberListResponse> {\n        // Simplified search without cross-module queries\n        val members = if (role != null) {\n            memberRepository.findByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, role, pageable)\n        } else {\n            memberRepository.findByWorkspaceIdAndIsActiveTrueOrderByJoinedAtDesc(workspaceId, pageable)\n        }\n        \n        // TODO: If advanced user search is needed, implement it at the service layer\n        // by fetching user data separately and filtering results\n\n        return members.map { it.toListResponse() }\n    }\n\n    /**\n     * Get members by role\n     */\n    fun getMembersByRole(workspaceId: String, role: WorkspaceRole): List<MemberListResponse> {\n        val members = memberRepository.findByWorkspaceIdAndRole(workspaceId, role)\n        return members.map { it.toListResponse() }\n    }\n\n    /**\n     * Update member last activity\n     */\n    fun updateMemberActivity(workspaceId: String, userId: String) {\n        val member = memberRepository.findByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)\n            .orElse(null) ?: return\n        memberRepository.updateLastActivity(member.uid, LocalDateTime.now())\n    }\n\n    /**\n     * Remove all members from workspace (used during workspace deletion)\n     */\n    fun removeAllMembers(workspaceId: String) {\n        val deletedCount = memberRepository.deleteByWorkspaceId(workspaceId)\n        logger.info(\"Removed $deletedCount members from workspace: $workspaceId\")\n    }\n\n    /**\n     * Bulk member operations\n     */\n    fun bulkMemberOperation(workspaceId: String, request: BulkMemberRequest, operatedBy: String): String {\n        val members = memberRepository.findByUidIn(request.memberIds)\n\n        // Validate all members belong to workspace\n        members.forEach { member ->\n            if (member.workspaceId != workspaceId) {\n                throw BusinessException(\"INVALID_MEMBER\", \"One or more members don't belong to this workspace\")\n            }\n        }\n\n        when (request.action) {\n            \"activate\" -> {\n                members.forEach { it.isActive = true }\n                memberRepository.saveAll(members)\n                activityService.logBulkMemberActivation(workspaceId, request.memberIds.size, operatedBy, \"Unknown User\")\n            }\n\n            \"deactivate\" -> {\n                members.forEach { it.isActive = false }\n                memberRepository.saveAll(members)\n                activityService.logBulkMemberDeactivation(\n                    workspaceId,\n                    request.memberIds.size,\n                    operatedBy,\n                    \"Unknown User\"\n                )\n            }\n\n            \"remove\" -> {\n                // Check for owners\n                val ownerCount =\n                    memberRepository.countByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, WorkspaceRole.OWNER)\n                val ownersToRemove = members.count { it.role == WorkspaceRole.OWNER }\n\n                if (ownerCount.toInt() - ownersToRemove <= 0) {\n                    throw BusinessException(\"CANNOT_REMOVE_ALL_OWNERS\", \"Cannot remove all owners from workspace\")\n                }\n\n                memberRepository.deleteAll(members)\n                activityService.logBulkMemberRemoval(workspaceId, request.memberIds.size, operatedBy, \"Unknown User\")\n            }\n\n            \"update_role\" -> {\n                request.role?.let { newRole ->\n                    members.forEach { it.role = newRole }\n                    memberRepository.saveAll(members)\n                    activityService.logBulkRoleUpdate(\n                        workspaceId,\n                        request.memberIds.size,\n                        newRole.name,\n                        operatedBy,\n                        \"Unknown User\"\n                    )\n                } ?: throw BusinessException(\"ROLE_REQUIRED\", \"Role is required for update_role action\")\n            }\n\n            else -> throw BusinessException(\"INVALID_ACTION\", \"Invalid bulk action: ${request.action}\")\n        }\n\n        return \"${request.action} operation completed for ${members.size} members\"\n    }\n\n    // Private helper methods\n\n    /**\n     * Advanced member search with multiple filters\n     */\n    fun searchWorkspaceMembers(\n        workspaceId: String,\n        searchQuery: String?,\n        role: String?,\n        status: String?,\n        department: String?,\n        pageable: Pageable\n    ): Page<MemberListResponse> {\n        // Convert string role to enum if provided\n        val roleEnum = role?.takeIf { it != \"ALL\" }?.let { \n            try { WorkspaceRole.valueOf(it) } catch (e: Exception) { null }\n        }\n        \n        // For now, use basic search and filtering\n        val members = when {\n            roleEnum != null -> memberRepository.findByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, roleEnum, pageable)\n            else -> memberRepository.findByWorkspaceIdAndIsActiveTrue(workspaceId, pageable)\n        }\n\n        // Batch-load user details when provider is available to populate nested user DTOs\n        if (userDetailProvider.isUserServiceAvailable()) {\n            val userIds = members.content.map { it.userId }\n            val userDetails = userDetailProvider.getUserDetails(userIds)\n            return members.map { member ->\n                val ud = userDetails[member.userId]\n                member.toListResponse(ud)\n            }\n        }\n        \n        return members.map { it.toListResponse() }\n    }\n\n    /**\n     * Get workspace departments\n     */\n    fun getWorkspaceDepartments(workspaceId: String): List<String> {\n        // TODO: Implement when department field is added to member entity\n        // For now return empty list\n        return emptyList()\n    }\n\n    /**\n     * Bulk update members\n     */\n    fun bulkUpdateMembers(workspaceId: String, request: Map<String, Any>): Map<String, Any> {\n        val memberIds = request[\"member_ids\"] as? List<String> ?: emptyList()\n        val role = request[\"role\"] as? String\n        val status = request[\"status\"] as? String\n        val notifyMembers = request[\"notify_members\"] as? Boolean ?: false\n        \n        val members = memberRepository.findByUidIn(memberIds)\n        var updatedCount = 0\n        val failedUpdates = mutableListOf<Map<String, String>>()\n        \n        members.forEach { member ->\n            try {\n                if (member.workspaceId == workspaceId) {\n                    role?.let { \n                        try {\n                            member.role = WorkspaceRole.valueOf(it)\n                        } catch (e: Exception) {\n                            failedUpdates.add(mapOf(\n                                \"member_id\" to member.uid,\n                                \"error\" to \"Invalid role: $it\"\n                            ))\n                            return@forEach\n                        }\n                    }\n                    \n                    status?.let { \n                        member.isActive = when(it) {\n                            \"ACTIVE\" -> true\n                            \"INACTIVE\" -> false\n                            else -> member.isActive\n                        }\n                    }\n                    \n                    memberRepository.save(member)\n                    updatedCount++\n                } else {\n                    failedUpdates.add(mapOf(\n                        \"member_id\" to member.uid,\n                        \"error\" to \"Member not in this workspace\"\n                    ))\n                }\n            } catch (e: Exception) {\n                failedUpdates.add(mapOf(\n                    \"member_id\" to member.uid,\n                    \"error\" to (e.message ?: \"Unknown error\")\n                ))\n            }\n        }\n        \n        return mapOf(\n            \"updated_count\" to updatedCount,\n            \"failed_updates\" to failedUpdates\n        )\n    }\n\n    /**\n     * Bulk remove members\n     */\n    fun bulkRemoveMembers(workspaceId: String, request: Map<String, Any>): Map<String, Any> {\n        val memberIds = request[\"member_ids\"] as? List<String> ?: emptyList()\n        val reason = request[\"reason\"] as? String\n        \n        val members = memberRepository.findByUidIn(memberIds)\n        var removedCount = 0\n        val failedRemovals = mutableListOf<Map<String, String>>()\n        \n        // Check for owners that would be removed\n        val ownerCount = memberRepository.countByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, WorkspaceRole.OWNER)\n        val ownersToRemove = members.count { it.role == WorkspaceRole.OWNER && it.workspaceId == workspaceId }\n        \n        if (ownerCount.toInt() - ownersToRemove <= 0) {\n            return mapOf(\n                \"removed_count\" to 0,\n                \"failed_removals\" to listOf(mapOf(\n                    \"error\" to \"Cannot remove all owners from workspace\"\n                ))\n            )\n        }\n        \n        members.forEach { member ->\n            try {\n                if (member.workspaceId == workspaceId) {\n                    memberRepository.delete(member)\n                    removedCount++\n                } else {\n                    failedRemovals.add(mapOf(\n                        \"member_id\" to member.uid,\n                        \"error\" to \"Member not in this workspace\"\n                    ))\n                }\n            } catch (e: Exception) {\n                failedRemovals.add(mapOf(\n                    \"member_id\" to member.uid,\n                    \"error\" to (e.message ?: \"Unknown error\")\n                ))\n            }\n        }\n        \n        return mapOf(\n            \"removed_count\" to removedCount,\n            \"failed_removals\" to failedRemovals\n        )\n    }\n\n    /**\n     * Export members data\n     */\n    fun exportMembers(\n        workspaceId: String, \n        format: String, \n        role: String?, \n        status: String?, \n        department: String?, \n        searchQuery: String?\n    ): ByteArray {\n        // Get filtered members\n        val roleEnum = role?.takeIf { it != \"ALL\" }?.let { \n            try { WorkspaceRole.valueOf(it) } catch (e: Exception) { null }\n        }\n        \n        val members = when {\n            roleEnum != null -> memberRepository.findByWorkspaceIdAndRole(workspaceId, roleEnum)\n            else -> memberRepository.findByWorkspaceIdOrderByCreatedAtDesc(workspaceId)\n        }\n        \n        // Generate CSV content\n        val csvContent = StringBuilder()\n        csvContent.append(\"Name,Email,Role,Status,Joined Date,Last Activity\\n\")\n        \n        members.forEach { member ->\n            csvContent.append(\"\\\"${member.userId}\\\",\")  // TODO: Get actual user name when user service is available\n            csvContent.append(\"\\\"${member.userId}@example.com\\\",\") // TODO: Get actual email\n            csvContent.append(\"\\\"${member.role.name}\\\",\")\n            csvContent.append(\"\\\"${if (member.isActive) \"ACTIVE\" else \"INACTIVE\"}\\\",\")\n            csvContent.append(\"\\\"${member.joinedAt}\\\",\")\n            csvContent.append(\"\\\"${member.lastActiveAt ?: \"\"}\\\"\\n\")\n        }\n        \n        return csvContent.toString().toByteArray(Charsets.UTF_8)\n    }\n\n    /**\n     * Update member status\n     */\n    fun updateMemberStatus(workspaceId: String, memberId: String, status: String, reason: String?): MemberResponse {\n        val member = findMemberById(memberId)\n        \n        if (member.workspaceId != workspaceId) {\n            throw BusinessException(\"MEMBER_NOT_IN_WORKSPACE\", \"Member does not belong to this workspace\")\n        }\n        \n        val wasActive = member.isActive\n        when (status.uppercase()) {\n            \"ACTIVE\" -> member.isActive = true\n            \"INACTIVE\" -> member.isActive = false\n            \"SUSPENDED\" -> member.isActive = false\n            else -> throw BusinessException(\"INVALID_STATUS\", \"Invalid status: $status\")\n        }\n        \n        val updatedMember = memberRepository.save(member)\n        val userDetail = if (userDetailProvider.isUserServiceAvailable()) userDetailProvider.getUserDetail(updatedMember.userId) else null\n        return updatedMember.toResponse(userDetail)\n    }\n\n    fun findMemberById(memberId: String): WorkspaceMember {\n        return memberRepository.findByUid(memberId)\n            .orElseThrow { NotFoundException(\"Member not found: $memberId\") }\n    }\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceMemberService.kt b/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceMemberService.kt
--- a/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceMemberService.kt	(revision 17c1f93ee95cfea6cba06c996df42a105b414d8a)
+++ b/workspace/src/main/kotlin/com/ampairs/workspace/service/WorkspaceMemberService.kt	(date 1756782540956)
@@ -7,6 +7,7 @@
 import com.ampairs.workspace.model.dto.*
 import com.ampairs.workspace.model.enums.WorkspaceRole
 import com.ampairs.workspace.repository.WorkspaceMemberRepository
+import com.ampairs.workspace.security.WorkspacePermission
 import org.slf4j.LoggerFactory
 import org.springframework.data.domain.Page
 import org.springframework.data.domain.Pageable
@@ -262,11 +263,11 @@
     fun getMemberById(memberId: String): MemberResponse {
         val member = memberRepository.findByIdWithPrimaryTeam(memberId)
             .orElseThrow { NotFoundException("Member not found: $memberId") }
-        
+
         val userDetail = if (userDetailProvider.isUserServiceAvailable()) {
             userDetailProvider.getUserDetail(member.userId)
         } else null
-        
+
         // The toResponse method will use the EntityGraph-loaded primaryTeam automatically
         return member.toResponse(userDetail)
     }
@@ -306,41 +307,39 @@
     /**
      * Check if user has specific permission
      */
-    fun hasPermission(workspaceId: String, userId: String, permission: String): Boolean {
+    fun hasPermission(workspaceId: String, userId: String, permission: WorkspacePermission): Boolean {
         return try {
             val member = memberRepository.findByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)
                 .orElse(null) ?: return false
 
             // Standardized permission mapping with clear, consistent naming
-            when (permission) {
+           return when (permission) {
                 // Workspace management permissions (consolidated)
-                "WORKSPACE_MANAGE", "WORKSPACE_UPDATE", "WORKSPACE_SETTINGS" ->
+                WorkspacePermission.WORKSPACE_MANAGE ->
                     member.role in listOf(WorkspaceRole.OWNER, WorkspaceRole.ADMIN)
 
-                "WORKSPACE_DELETE", "WORKSPACE_ARCHIVE" ->
+                WorkspacePermission.WORKSPACE_DELETE ->
                     member.role in listOf(WorkspaceRole.OWNER, WorkspaceRole.ADMIN)
 
                 // Member management permissions
-                "MEMBER_VIEW" -> true // All active members can view other members
-                "MEMBER_INVITE" -> member.role in listOf(
+                WorkspacePermission.MEMBER_VIEW -> true // All active members can view other members
+                WorkspacePermission.MEMBER_INVITE -> member.role in listOf(
                     WorkspaceRole.OWNER,
                     WorkspaceRole.ADMIN,
                     WorkspaceRole.MANAGER
                 )
 
-                "MEMBER_MANAGE" -> member.role in listOf(
+                WorkspacePermission.MEMBER_MANAGE -> member.role in listOf(
                     WorkspaceRole.OWNER,
                     WorkspaceRole.ADMIN,
                     WorkspaceRole.MANAGER
                 )
 
-                "MEMBER_DELETE", "MEMBER_REMOVE" -> member.role in listOf(
+                WorkspacePermission.MEMBER_DELETE -> member.role in listOf(
                     WorkspaceRole.OWNER,
                     WorkspaceRole.ADMIN,
                     WorkspaceRole.MANAGER
                 )
-
-                else -> false
             }
         } catch (e: Exception) {
             logger.warn("Error checking permissions for user $userId in workspace $workspaceId: ${e.message}")
@@ -350,7 +349,7 @@
                 memberRepository.existsByWorkspaceIdAndUserIdAndIsActiveTrue(workspaceId, userId)
                 // If exists but couldn't get role, be conservative and deny advanced permissions
                 when (permission) {
-                    "VIEW_MEMBERS" -> true // Basic permission
+                    WorkspacePermission.MEMBER_VIEW -> true // Basic permission
                     else -> false // Conservative approach for advanced permissions
                 }
             } catch (ex: Exception) {
@@ -417,7 +416,7 @@
         } else {
             memberRepository.findByWorkspaceIdAndIsActiveTrueOrderByJoinedAtDesc(workspaceId, pageable)
         }
-        
+
         // TODO: If advanced user search is needed, implement it at the service layer
         // by fetching user data separately and filtering results
 
@@ -528,13 +527,22 @@
         pageable: Pageable
     ): Page<MemberListResponse> {
         // Convert string role to enum if provided
-        val roleEnum = role?.takeIf { it != "ALL" }?.let { 
-            try { WorkspaceRole.valueOf(it) } catch (e: Exception) { null }
+        val roleEnum = role?.takeIf { it != "ALL" }?.let {
+            try {
+                WorkspaceRole.valueOf(it)
+            } catch (e: Exception) {
+                null
+            }
         }
-        
+
         // For now, use basic search and filtering
         val members = when {
-            roleEnum != null -> memberRepository.findByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, roleEnum, pageable)
+            roleEnum != null -> memberRepository.findByWorkspaceIdAndRoleAndIsActiveTrue(
+                workspaceId,
+                roleEnum,
+                pageable
+            )
+
             else -> memberRepository.findByWorkspaceIdAndIsActiveTrue(workspaceId, pageable)
         }
 
@@ -547,7 +555,7 @@
                 member.toListResponse(ud)
             }
         }
-        
+
         return members.map { it.toListResponse() }
     }
 
@@ -568,50 +576,56 @@
         val role = request["role"] as? String
         val status = request["status"] as? String
         val notifyMembers = request["notify_members"] as? Boolean ?: false
-        
+
         val members = memberRepository.findByUidIn(memberIds)
         var updatedCount = 0
         val failedUpdates = mutableListOf<Map<String, String>>()
-        
+
         members.forEach { member ->
             try {
                 if (member.workspaceId == workspaceId) {
-                    role?.let { 
+                    role?.let {
                         try {
                             member.role = WorkspaceRole.valueOf(it)
                         } catch (e: Exception) {
-                            failedUpdates.add(mapOf(
-                                "member_id" to member.uid,
-                                "error" to "Invalid role: $it"
-                            ))
+                            failedUpdates.add(
+                                mapOf(
+                                    "member_id" to member.uid,
+                                    "error" to "Invalid role: $it"
+                                )
+                            )
                             return@forEach
                         }
                     }
-                    
-                    status?.let { 
-                        member.isActive = when(it) {
+
+                    status?.let {
+                        member.isActive = when (it) {
                             "ACTIVE" -> true
                             "INACTIVE" -> false
                             else -> member.isActive
                         }
                     }
-                    
+
                     memberRepository.save(member)
                     updatedCount++
                 } else {
-                    failedUpdates.add(mapOf(
-                        "member_id" to member.uid,
-                        "error" to "Member not in this workspace"
-                    ))
+                    failedUpdates.add(
+                        mapOf(
+                            "member_id" to member.uid,
+                            "error" to "Member not in this workspace"
+                        )
+                    )
                 }
             } catch (e: Exception) {
-                failedUpdates.add(mapOf(
-                    "member_id" to member.uid,
-                    "error" to (e.message ?: "Unknown error")
-                ))
+                failedUpdates.add(
+                    mapOf(
+                        "member_id" to member.uid,
+                        "error" to (e.message ?: "Unknown error")
+                    )
+                )
             }
         }
-        
+
         return mapOf(
             "updated_count" to updatedCount,
             "failed_updates" to failedUpdates
@@ -624,43 +638,49 @@
     fun bulkRemoveMembers(workspaceId: String, request: Map<String, Any>): Map<String, Any> {
         val memberIds = request["member_ids"] as? List<String> ?: emptyList()
         val reason = request["reason"] as? String
-        
+
         val members = memberRepository.findByUidIn(memberIds)
         var removedCount = 0
         val failedRemovals = mutableListOf<Map<String, String>>()
-        
+
         // Check for owners that would be removed
         val ownerCount = memberRepository.countByWorkspaceIdAndRoleAndIsActiveTrue(workspaceId, WorkspaceRole.OWNER)
         val ownersToRemove = members.count { it.role == WorkspaceRole.OWNER && it.workspaceId == workspaceId }
-        
+
         if (ownerCount.toInt() - ownersToRemove <= 0) {
             return mapOf(
                 "removed_count" to 0,
-                "failed_removals" to listOf(mapOf(
-                    "error" to "Cannot remove all owners from workspace"
-                ))
+                "failed_removals" to listOf(
+                    mapOf(
+                        "error" to "Cannot remove all owners from workspace"
+                    )
+                )
             )
         }
-        
+
         members.forEach { member ->
             try {
                 if (member.workspaceId == workspaceId) {
                     memberRepository.delete(member)
                     removedCount++
                 } else {
-                    failedRemovals.add(mapOf(
-                        "member_id" to member.uid,
-                        "error" to "Member not in this workspace"
-                    ))
+                    failedRemovals.add(
+                        mapOf(
+                            "member_id" to member.uid,
+                            "error" to "Member not in this workspace"
+                        )
+                    )
                 }
             } catch (e: Exception) {
-                failedRemovals.add(mapOf(
-                    "member_id" to member.uid,
-                    "error" to (e.message ?: "Unknown error")
-                ))
+                failedRemovals.add(
+                    mapOf(
+                        "member_id" to member.uid,
+                        "error" to (e.message ?: "Unknown error")
+                    )
+                )
             }
         }
-        
+
         return mapOf(
             "removed_count" to removedCount,
             "failed_removals" to failedRemovals
@@ -671,27 +691,31 @@
      * Export members data
      */
     fun exportMembers(
-        workspaceId: String, 
-        format: String, 
-        role: String?, 
-        status: String?, 
-        department: String?, 
+        workspaceId: String,
+        format: String,
+        role: String?,
+        status: String?,
+        department: String?,
         searchQuery: String?
     ): ByteArray {
         // Get filtered members
-        val roleEnum = role?.takeIf { it != "ALL" }?.let { 
-            try { WorkspaceRole.valueOf(it) } catch (e: Exception) { null }
+        val roleEnum = role?.takeIf { it != "ALL" }?.let {
+            try {
+                WorkspaceRole.valueOf(it)
+            } catch (e: Exception) {
+                null
+            }
         }
-        
+
         val members = when {
             roleEnum != null -> memberRepository.findByWorkspaceIdAndRole(workspaceId, roleEnum)
             else -> memberRepository.findByWorkspaceIdOrderByCreatedAtDesc(workspaceId)
         }
-        
+
         // Generate CSV content
         val csvContent = StringBuilder()
         csvContent.append("Name,Email,Role,Status,Joined Date,Last Activity\n")
-        
+
         members.forEach { member ->
             csvContent.append("\"${member.userId}\",")  // TODO: Get actual user name when user service is available
             csvContent.append("\"${member.userId}@example.com\",") // TODO: Get actual email
@@ -700,7 +724,7 @@
             csvContent.append("\"${member.joinedAt}\",")
             csvContent.append("\"${member.lastActiveAt ?: ""}\"\n")
         }
-        
+
         return csvContent.toString().toByteArray(Charsets.UTF_8)
     }
 
@@ -709,11 +733,11 @@
      */
     fun updateMemberStatus(workspaceId: String, memberId: String, status: String, reason: String?): MemberResponse {
         val member = findMemberById(memberId)
-        
+
         if (member.workspaceId != workspaceId) {
             throw BusinessException("MEMBER_NOT_IN_WORKSPACE", "Member does not belong to this workspace")
         }
-        
+
         val wasActive = member.isActive
         when (status.uppercase()) {
             "ACTIVE" -> member.isActive = true
@@ -721,9 +745,10 @@
             "SUSPENDED" -> member.isActive = false
             else -> throw BusinessException("INVALID_STATUS", "Invalid status: $status")
         }
-        
+
         val updatedMember = memberRepository.save(member)
-        val userDetail = if (userDetailProvider.isUserServiceAvailable()) userDetailProvider.getUserDetail(updatedMember.userId) else null
+        val userDetail =
+            if (userDetailProvider.isUserServiceAvailable()) userDetailProvider.getUserDetail(updatedMember.userId) else null
         return updatedMember.toResponse(userDetail)
     }
 
