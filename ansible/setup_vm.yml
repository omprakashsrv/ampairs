---
- name: Configure Ampairs production VM
  hosts: all
  become: true
  gather_facts: true
  collections:
    - community.rabbitmq
  vars:
    domain_name: "{{ lookup('env', 'API_DOMAIN') | default('api.ampairs.in', true) }}"
    app_upstream: "{{ lookup('env', 'APP_UPSTREAM') | default('http://127.0.0.1:8080', true) }}"
    letsencrypt_email: "{{ lookup('env', 'LETSENCRYPT_EMAIL') | default('', true) }}"
    rabbitmq_admin_user: "{{ lookup('env', 'RABBITMQ_ADMIN_USER') | default('admin', true) }}"
    rabbitmq_admin_password: "{{ lookup('env', 'RABBITMQ_ADMIN_PASSWORD') | default('', true) }}"
    aws_access_key_id: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('', true) }}"
    aws_secret_access_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('', true) }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') | default('ap-south-1', true) }}"
    backup_db_type: "{{ lookup('env', 'BACKUP_DB_TYPE') | default('postgres', true) }}"
    backup_db_name: "{{ lookup('env', 'BACKUP_DB_NAME') | default('', true) }}"
    backup_db_host: "{{ lookup('env', 'BACKUP_DB_HOST') | default('localhost', true) }}"
    backup_db_port: "{{ lookup('env', 'BACKUP_DB_PORT') | default('5432', true) }}"
    backup_db_user: "{{ lookup('env', 'BACKUP_DB_USER') | default('', true) }}"
    backup_db_password: "{{ lookup('env', 'BACKUP_DB_PASSWORD') | default('', true) }}"
    backup_s3_bucket: "{{ lookup('env', 'BACKUP_S3_BUCKET') | default('', true) }}"
    backup_s3_prefix: "{{ lookup('env', 'BACKUP_S3_PREFIX') | default('', true) }}"
    backup_local_dir: "{{ lookup('env', 'BACKUP_LOCAL_DIR') | default('/var/backups/ampairs', true) }}"
    backup_retention_days: "{{ lookup('env', 'BACKUP_RETENTION_DAYS') | default('7', true) }}"
    backup_on_calendar: "{{ lookup('env', 'BACKUP_ON_CALENDAR') | default('daily', true) }}"

  pre_tasks:
    - name: Fail if Let's Encrypt email is not provided
      ansible.builtin.fail:
        msg: "LETSENCRYPT_EMAIL environment variable must be supplied to request certificates."
      when: letsencrypt_email | length == 0

    - name: Fail if RabbitMQ admin password is not provided
      ansible.builtin.fail:
        msg: "RABBITMQ_ADMIN_PASSWORD environment variable must be supplied for RabbitMQ user creation."
      when: rabbitmq_admin_password | length == 0

    - name: Fail if AWS credentials are not provided
      ansible.builtin.fail:
        msg: "AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environment variables must be supplied to configure AWS CLI."
      when: aws_access_key_id | length == 0 or aws_secret_access_key | length == 0

    - name: Fail if database backup configuration is incomplete
      ansible.builtin.fail:
        msg: "BACKUP_DB_NAME, BACKUP_DB_USER, BACKUP_DB_PASSWORD, and BACKUP_S3_BUCKET must be supplied for backups."
      when: backup_db_name | length == 0 or backup_db_user | length == 0 or backup_db_password | length == 0 or backup_s3_bucket | length == 0

  tasks:
    - name: Ensure APT cache is fresh
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Upgrade system packages
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - openjdk-21-jre
          - nginx
          - certbot
          - python3-certbot-nginx
          - rabbitmq-server
          - curl
          - postgresql-client
          - unzip
        state: present

    - name: Check current AWS CLI version
      ansible.builtin.command: aws --version
      register: aws_cli_version_check
      changed_when: false
      failed_when: false

    - name: Determine if AWS CLI install is required
      ansible.builtin.set_fact:
        aws_cli_install_needed: "{{ aws_cli_version_check.rc != 0 or 'aws-cli/2.' not in (aws_cli_version_check.stdout | default(aws_cli_version_check.stderr, true)) }}"

    - name: Install or update AWS CLI v2
      when: aws_cli_install_needed
      block:
        - name: Download AWS CLI v2 installer
          ansible.builtin.get_url:
            url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
            dest: /tmp/awscliv2.zip
            mode: "0644"

        - name: Unpack AWS CLI v2 installer
          ansible.builtin.unarchive:
            src: /tmp/awscliv2.zip
            dest: /tmp
            remote_src: true
            creates: /tmp/aws/install

        - name: Run AWS CLI v2 installer
          ansible.builtin.command: /tmp/aws/install --bin-dir /usr/local/bin --install-dir /usr/local/aws-cli --update
          args:
            creates: /usr/local/aws-cli/v2/current/bin/aws

        - name: Clean up AWS CLI installer artifacts
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/awscliv2.zip
            - /tmp/aws

    - name: Ensure nginx service is enabled and started
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

    - name: Check if nginx site configuration exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/{{ domain_name }}.conf
      register: nginx_site_conf

    - name: Create initial nginx site configuration when missing
      ansible.builtin.template:
        src: templates/api-ampairs-base.conf.j2
        dest: /etc/nginx/sites-available/{{ domain_name }}.conf
        owner: root
        group: root
        mode: "0644"
      when: not nginx_site_conf.stat.exists

    - name: Ensure ampairs proxy location block is present
      ansible.builtin.blockinfile:
        path: /etc/nginx/sites-available/{{ domain_name }}.conf
        marker: "# {mark} ampairs proxy"
        block: "{{ lookup('template', 'templates/api-ampairs-location.conf.j2') }}"
        insertafter: 'server_name'

    - name: Ensure AWS CLI configuration directory exists
      ansible.builtin.file:
        path: /root/.aws
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Configure AWS CLI credentials for backup profile
      ansible.builtin.copy:
        dest: /root/.aws/credentials
        owner: root
        group: root
        mode: "0600"
        content: |
          [backup]
          aws_access_key_id = {{ aws_access_key_id }}
          aws_secret_access_key = {{ aws_secret_access_key }}
      no_log: true

    - name: Configure AWS CLI profile settings
      ansible.builtin.copy:
        dest: /root/.aws/config
        owner: root
        group: root
        mode: "0600"
        content: |
          [profile backup]
          region = {{ aws_region }}

    - name: Ensure local backup directory exists
      ansible.builtin.file:
        path: "{{ backup_local_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Deploy database backup environment file
      ansible.builtin.template:
        src: templates/ampairs-db-backup.env.j2
        dest: /etc/ampairs-db-backup.env
        owner: root
        group: root
        mode: "0600"
      no_log: true

    - name: Deploy database backup script
      ansible.builtin.template:
        src: templates/ampairs-db-backup.sh.j2
        dest: /usr/local/bin/ampairs-db-backup.sh
        owner: root
        group: root
        mode: "0750"

    - name: Deploy database restore script
      ansible.builtin.template:
        src: templates/ampairs-db-restore.sh.j2
        dest: /usr/local/bin/ampairs-db-restore.sh
        owner: root
        group: root
        mode: "0750"

    - name: Deploy database backup systemd service
      ansible.builtin.template:
        src: templates/ampairs-db-backup.service.j2
        dest: /etc/systemd/system/ampairs-db-backup.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy database backup systemd timer
      ansible.builtin.template:
        src: templates/ampairs-db-backup.timer.j2
        dest: /etc/systemd/system/ampairs-db-backup.timer
        owner: root
        group: root
        mode: "0644"

    - name: Reload systemd to pick up backup units
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Ensure database backup timer is enabled
      ansible.builtin.systemd:
        name: ampairs-db-backup.timer
        enabled: true
        state: started

    - name: Enable ampairs nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/{{ domain_name }}.conf
        dest: /etc/nginx/sites-enabled/{{ domain_name }}.conf
        state: link
        force: true

    - name: Disable default nginx site if present
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Test nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Reload nginx to apply configuration
      ansible.builtin.service:
        name: nginx
        state: reloaded

    - name: Obtain or renew Let's Encrypt certificate
      ansible.builtin.command: >
        certbot --nginx --non-interactive --agree-tos
        --redirect --email {{ letsencrypt_email }}
        -d {{ domain_name }}
      register: certbot_result
      changed_when: >
        'Certificate not yet due for renewal' not in
        ((certbot_result.stdout | default('')) ~ (certbot_result.stderr | default('')))

    - name: Ensure certbot timer is enabled for auto renewals
      ansible.builtin.systemd:
        name: certbot.timer
        state: started
        enabled: true

    - name: Enable RabbitMQ service
      ansible.builtin.service:
        name: rabbitmq-server
        state: started
        enabled: true

    - name: Enable RabbitMQ STOMP plugin
      community.rabbitmq.rabbitmq_plugin:
        name: rabbitmq_stomp
        state: enabled

    - name: Ensure RabbitMQ administrator user exists
      community.rabbitmq.rabbitmq_user:
        user: "{{ rabbitmq_admin_user }}"
        password: "{{ rabbitmq_admin_password }}"
        vhost: /
        configure_priv: ".*"
        read_priv: ".*"
        write_priv: ".*"
        tags:
          - administrator
        state: present

    - name: Validate Java 21 is installed
      ansible.builtin.command: java -version
      register: java_version
      changed_when: false

    - name: Display Java version
      ansible.builtin.debug:
        var: java_version.stderr_lines

    - name: Validate nginx service status
      ansible.builtin.service_facts:

    - name: Assert nginx is running
      ansible.builtin.assert:
        that:
          - ansible_facts.services['nginx.service'].state == 'running'
        fail_msg: "nginx service is not running."
        success_msg: "nginx service is running."

    - name: Validate certificate files exist
      ansible.builtin.stat:
        path: /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem
      register: cert_stat

    - name: Assert certificate was created
      ansible.builtin.assert:
        that:
          - cert_stat.stat.exists
        fail_msg: "Let's Encrypt certificate was not created for {{ domain_name }}."
        success_msg: "Let's Encrypt certificate is present."

    - name: Validate HTTPS endpoint responds locally
      ansible.builtin.command: >
        curl -Ik --resolve {{ domain_name }}:443:127.0.0.1 https://{{ domain_name }}
      register: https_probe
      failed_when: https_probe.rc != 0
      changed_when: false

    - name: Validate RabbitMQ user can authenticate
      ansible.builtin.command: >
        rabbitmqctl authenticate_user {{ rabbitmq_admin_user }} {{ rabbitmq_admin_password }}
      register: rabbitmq_auth
      failed_when: >
        rabbitmq_auth.rc != 0 or
        ('success' not in (rabbitmq_auth.stdout | lower))
      changed_when: false

    - name: Report RabbitMQ authentication output
      ansible.builtin.debug:
        var: rabbitmq_auth.stdout

    - name: Validate AWS CLI installation
      ansible.builtin.command: aws --version
      register: aws_cli_version
      changed_when: false

    - name: Display AWS CLI version
      ansible.builtin.debug:
        msg: "{{ aws_cli_version.stdout | default(aws_cli_version.stderr, true) }}"

    - name: Confirm database backup timer is scheduled
      ansible.builtin.command: systemctl list-timers ampairs-db-backup.timer --no-legend
      register: backup_timer
      changed_when: false
      failed_when: backup_timer.rc != 0 or (backup_timer.stdout | length) == 0

    - name: Show next database backup run
      ansible.builtin.debug:
        var: backup_timer.stdout_lines
