# Migration Baseline Guide

This document explains how the Ampairs backend uses Flyway baselines for environments that already contain data created through `ddl-auto` or manual scripts.

## What is Baseline?
Flyway's baseline feature marks an existing database as having applied migrations up to a specific version without running them. When `baseline-on-migrate=true`, Flyway automatically inserts a baseline row into `flyway_schema_history` (version `0`) before applying new migrations. This prevents Flyway from re-creating tables that already exist.

## Current Baseline State
- Existing production and staging databases are expected to contain schema generated by Hibernate prior to introducing Flyway.
- Migrations `V3_1` and `V3_2` (tax/event modules) now live in their respective modules (`tax` and `event`) under `src/main/resources/db/migration/mysql/`.
- Retail migrations `V4_1` through `V4_8` live in their respective modules under `src/main/resources/db/migration/mysql/` and are loaded via the service classpath.

## Fresh Database Setup
1. Clone the repository and ensure Docker is running.
2. Start dependent services if required: `docker compose up -d mysql` (or use Testcontainers).
3. Configure datasource credentials via environment variables (`SPRING_DATASOURCE_URL`, `SPRING_DATASOURCE_USERNAME`, `SPRING_DATASOURCE_PASSWORD`).
4. Run migrations: `./gradlew :ampairs_service:flywayMigrate`.
5. Verify schema: `docker exec mysql mysql -u root -p -e "SHOW TABLES;"` or use a MySQL client.
6. Start the application with `SPRING_PROFILES_ACTIVE=test` and confirm `ddl-auto:validate` passes.

## Existing Database Baseline
- `baseline-on-migrate=true` ensures Flyway inserts a baseline row automatically when the schema history table is missing.
- No manual `flywayBaseline` invocation is required unless migrating a database that already has Flyway history with a different version.
- If manual intervention is necessary, run:
  ```
  ./gradlew :ampairs_service:flywayBaseline -Dflyway.baselineVersion=0
  ./gradlew :ampairs_service:flywayMigrate
  ```

## Production Deployment Checklist
- Take a full database backup (snapshot or `mysqldump`) before applying migrations.
- Validate migrations in a staging environment that mirrors production data volume.
- Run `./gradlew :ampairs_service:flywayValidate` and review output.
- Start the service with `ddl-auto:validate` and monitor logs for schema mismatches.
- Monitor application metrics and database error logs during the first deployment window.

## Rollback Strategy
- There are no automatic down migrations; reversing changes requires manual SQL.
- Drop new tables or columns in reverse dependency order (form → invoice → order → inventory → product → customer → unit → core).
- If a migration partially applied, fix the schema manually, then run `flyway repair` to mark it as failed and re-apply a corrected migration.

## Environment-specific Notes
- **Development**: `flywayClean` is allowed; developers may reset their local database frequently.
- **Staging**: Use `flywayClean` cautiously. Prefer refreshing from production backups followed by `flywayBaseline`.
- **Production**: Never run `flywayClean`. Only apply tested migrations and rely on `baseline-on-migrate` to bridge historical tables.
- Keep `SPRING_PROFILES_ACTIVE=prod` with `ddl-auto:validate` to catch mismatches immediately.
