name: Ampairs Service CI/CD Pipeline

on:
  push:
    branches: [ main, sandbox ]
  pull_request:
    branches: [ main, sandbox ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - sandbox
          - production

jobs:
  # CI Job: Runs on Pull Requests (build + test only, no deployment)
  ci:
    name: CI - Build & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x ampairs-backend/gradlew

    - name: Run tests
      run: cd ampairs-backend && ./gradlew test

    - name: Build application
      run: cd ampairs-backend && ./gradlew :ampairs_service:bootJar
      env:
        SPRING_PROFILES_ACTIVE: ${{ vars.SPRING_PROFILES_ACTIVE || 'production' }}

    - name: Verify build output
      run: |
        echo "Checking build output..."
        ls -lh ampairs-backend/ampairs_service/build/libs/

        # Find the JAR file (exclude -plain.jar files)
        JAR_FILE=$(ls ampairs-backend/ampairs_service/build/libs/*.jar 2>/dev/null | grep -v '\-plain\.jar$' | head -1)

        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: No JAR file was built!"
          exit 1
        fi

        JAR_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null)
        echo "JAR file: $JAR_FILE"
        echo "JAR size: $JAR_SIZE bytes ($(($JAR_SIZE / 1024 / 1024)) MB)"

        # Verify JAR is at least 10MB (Spring Boot apps are typically 50MB+)
        if [ "$JAR_SIZE" -lt 10485760 ]; then
          echo "ERROR: JAR file is too small ($JAR_SIZE bytes). Build likely failed."
          echo "Expected at least 10MB for a Spring Boot application."
          exit 1
        fi

        # Verify JAR integrity
        if ! unzip -t "$JAR_FILE" > /dev/null 2>&1; then
          echo "ERROR: JAR file is corrupted or invalid"
          exit 1
        fi

        echo "âœ… JAR file is valid (CI check passed)"

  # Build Job: Runs on merges to main/sandbox (creates artifacts for deployment)
  build:
    name: Build for Deployment
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x ampairs-backend/gradlew

    - name: Run tests
      run: cd ampairs-backend && ./gradlew test

    - name: Build application
      run: cd ampairs-backend && ./gradlew :ampairs_service:bootJar
      env:
        SPRING_PROFILES_ACTIVE: ${{ vars.SPRING_PROFILES_ACTIVE || 'production' }}

    - name: Verify build output
      run: |
        echo "Checking build output..."
        ls -lh ampairs-backend/ampairs_service/build/libs/

        # Find the JAR file (exclude -plain.jar files)
        JAR_FILE=$(ls ampairs-backend/ampairs_service/build/libs/*.jar 2>/dev/null | grep -v '\-plain\.jar$' | head -1)

        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: No JAR file was built!"
          exit 1
        fi

        JAR_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null)
        echo "JAR file: $JAR_FILE"
        echo "JAR size: $JAR_SIZE bytes ($(($JAR_SIZE / 1024 / 1024)) MB)"

        # Verify JAR is at least 10MB (Spring Boot apps are typically 50MB+)
        if [ "$JAR_SIZE" -lt 10485760 ]; then
          echo "ERROR: JAR file is too small ($JAR_SIZE bytes). Build likely failed."
          echo "Expected at least 10MB for a Spring Boot application."
          exit 1
        fi

        # Verify JAR integrity
        if ! unzip -t "$JAR_FILE" > /dev/null 2>&1; then
          echo "ERROR: JAR file is corrupted or invalid"
          exit 1
        fi

        echo "âœ… JAR file is valid and ready for deployment"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ampairs-service-jar
        path: |
          ampairs-backend/ampairs_service/build/libs/*.jar
          !ampairs-backend/ampairs_service/build/libs/*-plain.jar

  deploy-sandbox:
    name: Deploy to Sandbox
    needs: build
    runs-on: ubuntu-latest
    environment: sandbox
    if: (github.ref == 'refs/heads/sandbox' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'sandbox')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ampairs-service-jar
        path: ./artifacts

    - name: Setup SSH
      run: |
        set -e  # Exit on any error

        # Create SSH directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        # Write SSH private key (ensure it ends with newline)
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        echo "" >> ~/.ssh/id_rsa  # Ensure trailing newline
        chmod 600 ~/.ssh/id_rsa

        # Verify key format
        if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
          echo "ERROR: SSH private key does not appear to be valid"
          echo "Key should start with '-----BEGIN ... PRIVATE KEY-----'"
          exit 1
        fi

        # Test SSH key format
        if ! ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
          echo "ERROR: SSH private key format is invalid"
          echo "Please check that SSH_PRIVATE_KEY secret contains a valid private key"
          exit 1
        fi

        echo "SSH key validated successfully"

        # Add server to known_hosts with timeout
        echo "Scanning SSH host keys for ${{ vars.SERVER_HOST }}..."
        if ! timeout 10 ssh-keyscan -H ${{ vars.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1; then
          echo "WARNING: ssh-keyscan failed or timed out"
          echo "Attempting connection anyway (may prompt for host verification)"
        fi

        chmod 600 ~/.ssh/known_hosts
        echo "SSH setup completed"

    - name: Copy files to server
      run: |
        # Verify JAR file exists locally
        echo "Checking for JAR files in artifacts directory..."
        ls -lh ./artifacts/

        # Find the JAR file (exclude -plain.jar files)
        JAR_FILE=$(ls ./artifacts/*.jar | grep -v '\-plain\.jar$' | head -1)
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: No JAR file found in artifacts directory"
          exit 1
        fi

        echo "Found JAR file: $JAR_FILE"
        echo "File size: $(ls -lh $JAR_FILE | awk '{print $5}')"

        # Verify Firebase key exists locally
        if [ ! -f ./ampairs-backend/ampairs_service/keys/ampairs-firebase-adminsdk.json ]; then
          echo "ERROR: Firebase service account key not found"
          exit 1
        fi
        echo "Firebase key verified"

        # Remove any existing files/directories on server
        echo "Cleaning up old files on server..."
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} 'rm -rf ~/ampairs-service.jar ~/ampairs-sandbox.service ~/ampairs-firebase-key.json'

        # Copy JAR to server
        echo "Copying JAR to server..."
        scp -v "$JAR_FILE" ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }}:~/ampairs-service.jar

        # Copy service file to server
        echo "Copying service file to server..."
        scp -v ./scripts/ampairs-sandbox.service ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }}:~/ampairs-sandbox.service

        # Copy Firebase key to server
        echo "Copying Firebase service account key to server..."
        scp -v ./ampairs-backend/ampairs_service/keys/ampairs-firebase-adminsdk.json ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }}:~/ampairs-firebase-key.json

        echo "Files copied successfully!"

        # Verify files were uploaded
        echo "Verifying files on server..."
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} << 'VERIFY_EOF'
          echo "Files in home directory:"
          ls -lh ~/ampairs* 2>/dev/null || echo "ERROR: No ampairs files found after upload!"
        VERIFY_EOF

    - name: Deploy application
      run: |
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} << 'EOF'
          # Debug: Show what files are in home directory
          echo "=== Files in home directory ==="
          ls -lha ~/
          echo "=== Looking for ampairs files ==="
          ls -lh ~/ampairs* 2>/dev/null || echo "No ampairs files found"
          echo "================================"

          # Create ampairs user if it doesn't exist
          if ! id ampairs &>/dev/null; then
            sudo useradd -r -s /bin/false ampairs
          fi

          # Create deployment directories
          sudo mkdir -p /opt/ampairs/sandbox/keys
          sudo mkdir -p /var/log/ampairs

          # Verify JAR file was uploaded correctly
          if [ ! -f ~/ampairs-service.jar ]; then
            echo "ERROR: JAR file not found in home directory"
            echo "Current directory: $(pwd)"
            echo "Files in current directory:"
            ls -la
            exit 1
          fi

          # Verify Firebase key was uploaded correctly
          if [ ! -f ~/ampairs-firebase-key.json ]; then
            echo "ERROR: Firebase key file not found in home directory"
            exit 1
          fi

          echo "JAR file size: $(ls -lh ~/ampairs-service.jar | awk '{print $5}')"
          echo "Firebase key size: $(ls -lh ~/ampairs-firebase-key.json | awk '{print $5}')"

          # Stop service before updating JAR
          sudo systemctl stop ampairs-sandbox || true

          # Remove old JAR file (handle both file and directory cases)
          sudo rm -rf /opt/ampairs/sandbox/ampairs-service.jar

          # Copy new JAR to deployment directory
          sudo cp ~/ampairs-service.jar /opt/ampairs/sandbox/ampairs-service.jar

          # Copy Firebase key to deployment directory
          sudo cp ~/ampairs-firebase-key.json /opt/ampairs/sandbox/keys/ampairs-firebase-adminsdk.json

          # Verify JAR file integrity
          if ! unzip -t /opt/ampairs/sandbox/ampairs-service.jar > /dev/null 2>&1; then
            echo "ERROR: JAR file is corrupted"
            exit 1
          fi

          # Update systemd service file
          sudo cp ~/ampairs-sandbox.service /etc/systemd/system/ampairs-sandbox.service

          # Set ownership and permissions
          sudo chown -R ampairs:ampairs /opt/ampairs/sandbox
          sudo chown -R ampairs:ampairs /var/log/ampairs
          sudo chmod 644 /etc/systemd/system/ampairs-sandbox.service

          # Clean up uploaded files
          rm ~/ampairs-service.jar ~/ampairs-sandbox.service ~/ampairs-firebase-key.json

          # Reload systemd and restart service
          sudo systemctl daemon-reload
          sudo systemctl enable ampairs-sandbox
          sudo systemctl restart ampairs-sandbox

          # Wait for service to stabilize
          sleep 5

          # Show service status
          sudo systemctl status ampairs-sandbox --no-pager || true
        EOF

    - name: Health check
      run: |
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} << 'EOF'
          echo "Waiting for application to start..."
          sleep 30

          # Check if application is responding (sandbox runs on port 8081)
          for i in {1..10}; do
            if curl -f http://localhost:8081/actuator/health; then
              echo "âœ… Sandbox application is healthy!"
              exit 0
            fi
            echo "â³ Attempt $i/10: Waiting for application..."
            sleep 10
          done

          echo "âŒ Application health check failed"
          exit 1
        EOF

  deploy-production:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    environment: production
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ampairs-service-jar
        path: ./artifacts

    - name: Setup SSH
      run: |
        set -e  # Exit on any error

        # Create SSH directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        # Write SSH private key (ensure it ends with newline)
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        echo "" >> ~/.ssh/id_rsa  # Ensure trailing newline
        chmod 600 ~/.ssh/id_rsa

        # Verify key format
        if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
          echo "ERROR: SSH private key does not appear to be valid"
          echo "Key should start with '-----BEGIN ... PRIVATE KEY-----'"
          exit 1
        fi

        # Test SSH key format
        if ! ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
          echo "ERROR: SSH private key format is invalid"
          echo "Please check that SSH_PRIVATE_KEY secret contains a valid private key"
          exit 1
        fi

        echo "SSH key validated successfully"

        # Add server to known_hosts with timeout
        echo "Scanning SSH host keys for ${{ vars.SERVER_HOST }}..."
        if ! timeout 10 ssh-keyscan -H ${{ vars.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1; then
          echo "WARNING: ssh-keyscan failed or timed out"
          echo "Attempting connection anyway (may prompt for host verification)"
        fi

        chmod 600 ~/.ssh/known_hosts
        echo "SSH setup completed"

    - name: Copy files to server
      run: |
        # Verify JAR file exists locally
        echo "Checking for JAR files in artifacts directory..."
        ls -lh ./artifacts/

        # Find the JAR file (exclude -plain.jar files)
        JAR_FILE=$(ls ./artifacts/*.jar | grep -v '\-plain\.jar$' | head -1)
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: No JAR file found in artifacts directory"
          exit 1
        fi

        echo "Found JAR file: $JAR_FILE"
        echo "File size: $(ls -lh $JAR_FILE | awk '{print $5}')"

        # Verify Firebase key exists locally
        if [ ! -f ./ampairs-backend/ampairs_service/keys/ampairs-firebase-adminsdk.json ]; then
          echo "ERROR: Firebase service account key not found"
          exit 1
        fi
        echo "Firebase key verified"

        # Remove any existing files/directories on server
        echo "Cleaning up old files on server..."
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} 'rm -rf ~/ampairs-service.jar ~/ampairs-production.service ~/ampairs-firebase-key.json'

        # Copy JAR to server
        echo "Copying JAR to server..."
        scp -v "$JAR_FILE" ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }}:~/ampairs-service.jar

        # Copy service file to server
        echo "Copying service file to server..."
        scp -v ./scripts/ampairs-production.service ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }}:~/ampairs-production.service

        # Copy Firebase key to server
        echo "Copying Firebase service account key to server..."
        scp -v ./ampairs-backend/ampairs_service/keys/ampairs-firebase-adminsdk.json ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }}:~/ampairs-firebase-key.json

        echo "Files copied successfully!"

        # Verify files were uploaded
        echo "Verifying files on server..."
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} << 'VERIFY_EOF'
          echo "Files in home directory:"
          ls -lh ~/ampairs* 2>/dev/null || echo "ERROR: No ampairs files found after upload!"
        VERIFY_EOF

    - name: Deploy application
      run: |
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} << 'EOF'
          # Debug: Show what files are in home directory
          echo "=== Files in home directory ==="
          ls -lha ~/
          echo "=== Looking for ampairs files ==="
          ls -lh ~/ampairs* 2>/dev/null || echo "No ampairs files found"
          echo "================================"

          # Create ampairs user if it doesn't exist
          if ! id ampairs &>/dev/null; then
            sudo useradd -r -s /bin/false ampairs
          fi

          # Create deployment directories
          sudo mkdir -p /opt/ampairs/production/keys
          sudo mkdir -p /var/log/ampairs

          # Verify JAR file was uploaded correctly
          if [ ! -f ~/ampairs-service.jar ]; then
            echo "ERROR: JAR file not found in home directory"
            echo "Current directory: $(pwd)"
            echo "Files in current directory:"
            ls -la
            exit 1
          fi

          # Verify Firebase key was uploaded correctly
          if [ ! -f ~/ampairs-firebase-key.json ]; then
            echo "ERROR: Firebase key file not found in home directory"
            exit 1
          fi

          echo "JAR file size: $(ls -lh ~/ampairs-service.jar | awk '{print $5}')"
          echo "Firebase key size: $(ls -lh ~/ampairs-firebase-key.json | awk '{print $5}')"

          # Stop service before updating JAR
          sudo systemctl stop ampairs-production || true

          # Remove old JAR file (handle both file and directory cases)
          sudo rm -rf /opt/ampairs/production/ampairs-service.jar

          # Copy new JAR to deployment directory
          sudo cp ~/ampairs-service.jar /opt/ampairs/production/ampairs-service.jar

          # Copy Firebase key to deployment directory
          sudo cp ~/ampairs-firebase-key.json /opt/ampairs/production/keys/ampairs-firebase-adminsdk.json

          # Verify JAR file integrity
          if ! unzip -t /opt/ampairs/production/ampairs-service.jar > /dev/null 2>&1; then
            echo "ERROR: JAR file is corrupted"
            exit 1
          fi

          # Update systemd service file
          sudo cp ~/ampairs-production.service /etc/systemd/system/ampairs-production.service

          # Set ownership and permissions
          sudo chown -R ampairs:ampairs /opt/ampairs/production
          sudo chown -R ampairs:ampairs /var/log/ampairs
          sudo chmod 644 /etc/systemd/system/ampairs-production.service

          # Clean up uploaded files
          rm ~/ampairs-service.jar ~/ampairs-production.service ~/ampairs-firebase-key.json

          # Reload systemd and restart service
          sudo systemctl daemon-reload
          sudo systemctl enable ampairs-production
          sudo systemctl restart ampairs-production

          # Wait for service to stabilize
          sleep 5

          # Show service status
          sudo systemctl status ampairs-production --no-pager || true
        EOF

    - name: Health check
      run: |
        ssh ${{ vars.SSH_USER }}@${{ vars.SERVER_HOST }} << 'EOF'
          echo "Waiting for application to start..."
          sleep 30

          # Check if application is responding (production runs on port 8080)
          for i in {1..10}; do
            if curl -f http://localhost:8080/actuator/health; then
              echo "âœ… Production application is healthy!"
              exit 0
            fi
            echo "â³ Attempt $i/10: Waiting for application..."
            sleep 10
          done

          echo "âŒ Application health check failed"
          exit 1
        EOF

  notification:
    name: Send Notification
    needs: [build, deploy-sandbox, deploy-production]
    runs-on: ubuntu-latest
    if: always() && github.event_name != 'pull_request'

    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy-sandbox.result }}" == "success" ]; then
          echo "ðŸŽ‰ Sandbox deployment successful!"
          echo "âœ… Ampairs service deployed to sandbox"
        elif [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "ðŸŽ‰ Production deployment successful!"
          echo "âœ… Ampairs service deployed to production"
        else
          echo "âŒ Deployment failed!"
          echo "ðŸš¨ Check the logs for details"
        fi
